<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataView | Electrogrupo S.A.C.I.</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: #0a0f1c;
            --bg-secondary: #111827;
            --bg-card: #1a2234;
            --bg-card-hover: #1f2a40;
            --accent-blue: #3b82f6;
            --accent-cyan: #06b6d4;
            --accent-green: #10b981;
            --accent-yellow: #f59e0b;
            --accent-red: #ef4444;
            --accent-purple: #8b5cf6;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: rgba(255,255,255,0.08);
            --glow-blue: rgba(59, 130, 246, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Background Pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(6, 182, 212, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        /* ==================== LOGIN PAGE ==================== */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-box {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 48px;
            width: 100%;
            max-width: 420px;
            text-align: center;
        }

        .login-logo {
            width: 72px;
            height: 72px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 24px;
            color: white;
            margin: 0 auto 24px;
            box-shadow: 0 8px 32px var(--glow-blue);
        }

        .login-box h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .login-box p {
            color: var(--text-muted);
            font-size: 14px;
            margin-bottom: 32px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-group input {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn {
            padding: 14px 28px;
            border-radius: 12px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--glow-blue);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .login-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--accent-red);
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 20px;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        /* ==================== DASHBOARD ==================== */
        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .login-container.hidden {
            display: none;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: rgba(10, 15, 28, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            z-index: 1000;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            color: white;
        }

        .logo-text h1 {
            font-size: 16px;
            font-weight: 600;
        }

        .logo-text span {
            font-size: 11px;
            color: var(--text-muted);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .fazenda-name {
            font-size: 13px;
            color: var(--text-secondary);
            padding: 8px 16px;
            background: var(--bg-card);
            border-radius: 8px;
        }

        .btn-logout {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-logout:hover {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        .btn-admin {
            padding: 8px 16px;
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-admin:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .btn-report {
            padding: 8px 16px;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-report:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        /* Report Modal */
        .report-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .report-modal.active {
            display: flex;
        }

        .report-modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .report-modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .report-modal-header h3 {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .report-modal-body {
            padding: 24px;
        }

        .report-section {
            margin-bottom: 24px;
        }

        .report-section h4 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-secondary);
        }

        .report-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .report-option {
            padding: 16px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .report-option:hover {
            border-color: var(--accent-blue);
            background: var(--bg-card-hover);
        }

        .report-option.selected {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.1);
        }

        .report-option .icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .report-option .label {
            font-size: 13px;
            font-weight: 500;
        }

        .report-date-range {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .report-date-range .form-group {
            margin-bottom: 0;
        }

        .report-date-range input {
            width: 100%;
            padding: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
        }

        .report-date-range input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .report-checkboxes {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .report-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .report-checkbox input {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-blue);
        }

        .report-checkbox label {
            font-size: 14px;
            cursor: pointer;
        }

        .device-select {
            width: 100%;
            padding: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
        }

        .device-select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .report-modal-footer {
            padding: 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn-generate {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--glow-blue);
        }

        .btn-generate:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-cancel {
            padding: 12px 24px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
        }

        .btn-cancel:hover {
            background: var(--bg-card-hover);
        }

        /* Report Preview */
        .report-preview {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 3000;
            padding: 20px;
            overflow-y: auto;
        }

        .report-preview.active {
            display: block;
        }

        .report-preview-actions {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 12px;
            z-index: 3001;
        }

        .report-container {
            background: white;
            color: #1a1a1a;
            max-width: 800px;
            margin: 0 auto;
            padding: 40px;
            border-radius: 8px;
            font-family: 'Plus Jakarta Sans', Arial, sans-serif;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .report-logo img {
            height: 50px;
        }

        .report-info {
            text-align: right;
        }

        .report-info h1 {
            font-size: 24px;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .report-info p {
            font-size: 12px;
            color: #666;
        }

        .report-client-info {
            background: #f5f5f5;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
        }

        .report-client-info h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .report-client-info p {
            font-size: 14px;
            margin: 4px 0;
        }

        .report-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 30px;
        }

        .report-stat {
            background: #f0f7ff;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }

        .report-stat .value {
            font-size: 28px;
            font-weight: 700;
            color: #2563eb;
        }

        .report-stat .label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            margin-top: 4px;
        }

        .report-chart-container {
            margin-bottom: 30px;
        }

        .report-chart-container h3 {
            font-size: 16px;
            margin-bottom: 16px;
            color: #1a1a1a;
        }

        .report-chart {
            height: 250px;
            background: #f9f9f9;
            border-radius: 8px;
            padding: 16px;
        }

        .report-table-container {
            margin-bottom: 30px;
        }

        .report-table-container h3 {
            font-size: 16px;
            margin-bottom: 16px;
            color: #1a1a1a;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
        }

        .report-table th {
            background: #f0f0f0;
            padding: 10px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            border-bottom: 2px solid #ddd;
        }

        .report-table td {
            padding: 10px;
            font-size: 13px;
            border-bottom: 1px solid #eee;
        }

        .report-table tr:nth-child(even) {
            background: #f9f9f9;
        }

        .report-footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            font-size: 11px;
            color: #999;
            text-align: center;
        }

        .report-alerts {
            margin-bottom: 30px;
        }

        .report-alerts h3 {
            font-size: 16px;
            margin-bottom: 16px;
            color: #1a1a1a;
        }

        .alert-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            margin-bottom: 8px;
            border-radius: 0 8px 8px 0;
        }

        .alert-item.critical {
            background: #f8d7da;
            border-left-color: #dc3545;
        }

        .alert-item .icon {
            font-size: 20px;
        }

        .no-alerts {
            padding: 16px;
            background: #d4edda;
            border-radius: 8px;
            color: #155724;
            text-align: center;
        }

        /* Device Config Modal */
        .config-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .config-modal.active {
            display: flex;
        }

        .config-modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            width: 100%;
            max-width: 450px;
            overflow: hidden;
        }

        .config-modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .config-modal-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .config-modal-body {
            padding: 24px;
        }

        .config-group {
            margin-bottom: 20px;
        }

        .config-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .config-group input {
            width: 100%;
            padding: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
        }

        .config-group input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .config-group .hint {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .config-group .unit {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 13px;
        }

        .config-input-wrapper {
            position: relative;
        }

        .config-input-wrapper input {
            padding-right: 60px;
        }

        .config-modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn-config {
            padding: 6px 10px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-config:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .config-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: var(--bg-card);
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .config-status.configured {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .config-status.not-configured {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .config-status .icon {
            font-size: 18px;
        }

        .config-status .text {
            font-size: 13px;
        }

        /* Main Layout */
        .main-layout {
            margin-top: 70px;
            display: grid;
            grid-template-columns: 1fr 400px;
            height: calc(100vh - 70px);
        }

        /* Map */
        .map-container {
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .map-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 500;
            display: flex;
            gap: 12px;
        }

        .btn-refresh {
            padding: 12px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-refresh:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-blue);
        }

        .btn-refresh.loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .ultima-atualizacao {
            padding: 12px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            overflow-y: auto;
            padding: 24px;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .sidebar-header h2 {
            font-size: 18px;
            font-weight: 600;
        }

        .unit-toggle {
            display: flex;
            background: var(--bg-card);
            border-radius: 8px;
            padding: 4px;
        }

        .unit-btn {
            padding: 6px 12px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 12px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .unit-btn.active {
            background: var(--accent-blue);
            color: white;
        }

        /* Device Cards */
        .device-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .device-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .device-card:hover {
            border-color: var(--accent-blue);
            transform: translateX(-4px);
        }

        .device-card.selected {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .device-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .device-name-container {
            flex: 1;
        }

        .device-name {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .device-name input {
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 15px;
            font-weight: 600;
            padding: 0;
            width: 100%;
        }

        .device-name input:focus {
            outline: none;
            border-bottom: 1px solid var(--accent-blue);
        }

        .device-location {
            font-size: 12px;
            color: var(--text-muted);
        }

        .device-status {
            padding: 4px 10px;
            border-radius: 100px;
            font-size: 11px;
            font-weight: 500;
        }

        .device-status.online {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
        }

        .device-status.offline {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
        }

        .device-value {
            text-align: center;
            padding: 20px 0;
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 16px;
        }

        .device-value .value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 42px;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .device-value .unit {
            font-size: 16px;
            color: var(--text-muted);
            margin-left: 4px;
        }

        .device-value .timestamp {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .device-chart {
            height: 80px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            overflow: hidden;
        }

        /* Detail Panel */
        .detail-panel {
            display: none;
            position: fixed;
            top: 70px;
            right: 0;
            width: 500px;
            height: calc(100vh - 70px);
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            z-index: 900;
            overflow-y: auto;
            padding: 24px;
            animation: slideIn 0.3s ease;
        }

        .detail-panel.active {
            display: block;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }

        .detail-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .detail-header h3 {
            font-size: 20px;
            font-weight: 600;
        }

        .btn-close {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .btn-close:hover {
            color: var(--text-primary);
            border-color: var(--accent-blue);
        }

        .detail-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
        }

        .stat-card .label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 24px;
            font-weight: 600;
        }

        .detail-chart {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .detail-chart h4 {
            font-size: 14px;
            margin-bottom: 16px;
        }

        .chart-container {
            height: 200px;
            position: relative;
        }

        .detail-table {
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
        }

        .detail-table h4 {
            font-size: 14px;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .detail-table th {
            text-align: left;
            padding: 12px 20px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            background: rgba(0,0,0,0.2);
        }

        .detail-table td {
            padding: 12px 20px;
            font-size: 13px;
            border-top: 1px solid var(--border-color);
        }

        .detail-table .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 15, 28, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 16px 24px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            font-size: 14px;
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-color: var(--accent-green);
        }

        .toast.error {
            border-color: var(--accent-red);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
                grid-template-rows: 50vh 1fr;
            }

            .sidebar {
                border-left: none;
                border-top: 1px solid var(--border-color);
            }

            .detail-panel {
                width: 100%;
            }
        }

        @media (max-width: 640px) {
            .header {
                padding: 0 16px;
            }

            .fazenda-name {
                display: none;
            }

            .login-box {
                padding: 32px 24px;
            }

            .map-overlay {
                flex-direction: column;
            }
        }

        /* Custom Leaflet Markers */
        .custom-marker {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--accent-blue);
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }

        .leaflet-popup-content-wrapper {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .leaflet-popup-content {
            color: var(--text-primary);
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .leaflet-popup-tip {
            background: var(--bg-card);
        }

        .popup-content {
            padding: 8px;
        }

        .popup-content h4 {
            font-size: 14px;
            margin-bottom: 8px;
        }

        .popup-content .value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 24px;
            font-weight: 600;
            color: var(--accent-cyan);
        }

        .popup-content .unit {
            font-size: 12px;
            color: var(--text-muted);
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Login Page -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <div class="login-logo">EG</div>
            <h1>DataView</h1>
            <p>Electrogrupo S.A.C.I. - Sistema de Monitoramento</p>
            
            <div class="login-error" id="loginError"></div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="seu@email.com" required>
                </div>
                <div class="form-group">
                    <label>Senha</label>
                    <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="submit" class="btn btn-primary" id="loginBtn">Entrar</button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <!-- Header -->
        <header class="header">
            <div class="logo-container">
                <div class="logo-icon">EG</div>
                <div class="logo-text">
                    <h1>DataView</h1>
                    <span>Electrogrupo S.A.C.I.</span>
                </div>
            </div>
            <div class="header-right">
                <button class="btn-report" id="btnReport">üìä Relat√≥rios</button>
                <button class="btn-admin" id="btnAdmin" style="display:none" onclick="location.href='admin.html'">‚öôÔ∏è Admin</button>
                <div class="fazenda-name" id="fazendaNome">Carregando...</div>
                <button class="btn-logout" id="btnLogout">Sair</button>
            </div>
        </header>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Map -->
            <div class="map-container">
                <div id="map"></div>
                <div class="map-overlay">
                    <button class="btn-refresh" id="btnRefresh">
                        <span>‚Üª</span> Atualizar Dados
                    </button>
                    <div class="ultima-atualizacao" id="ultimaAtualizacao">
                        √öltima atualiza√ß√£o: --:--
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <h2>Dispositivos</h2>
                    <div class="unit-toggle">
                        <button class="unit-btn active" data-unit="m3h">m¬≥/h</button>
                        <button class="unit-btn" data-unit="ls">L/s</button>
                    </div>
                </div>
                <div class="device-list" id="deviceList">
                    <!-- Devices will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Detail Panel -->
        <div class="detail-panel" id="detailPanel">
            <div class="detail-header">
                <h3 id="detailTitle">Detalhes do Dispositivo</h3>
                <button class="btn-close" id="btnCloseDetail">√ó</button>
            </div>
            
            <div class="detail-stats" id="detailStats">
                <!-- Stats will be loaded here -->
            </div>

            <div class="detail-chart">
                <h4>Hist√≥rico (√∫ltima hora)</h4>
                <div class="chart-container">
                    <canvas id="detailChart"></canvas>
                </div>
            </div>

            <div class="detail-table">
                <h4>√öltimas Leituras</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Hor√°rio</th>
                            <th>Valor</th>
                        </tr>
                    </thead>
                    <tbody id="detailTableBody">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Report Modal -->
    <div class="report-modal" id="reportModal">
        <div class="report-modal-content">
            <div class="report-modal-header">
                <h3>üìä Gerar Relat√≥rio</h3>
                <button class="btn-close" onclick="closeReportModal()">√ó</button>
            </div>
            <div class="report-modal-body">
                <!-- Per√≠odo -->
                <div class="report-section">
                    <h4>Per√≠odo</h4>
                    <div class="report-options" id="periodOptions">
                        <div class="report-option" data-period="day" onclick="selectPeriod('day')">
                            <div class="icon">üìÖ</div>
                            <div class="label">Hoje</div>
                        </div>
                        <div class="report-option" data-period="week" onclick="selectPeriod('week')">
                            <div class="icon">üìÜ</div>
                            <div class="label">√öltima Semana</div>
                        </div>
                        <div class="report-option" data-period="month" onclick="selectPeriod('month')">
                            <div class="icon">üóìÔ∏è</div>
                            <div class="label">√öltimo M√™s</div>
                        </div>
                        <div class="report-option" data-period="custom" onclick="selectPeriod('custom')">
                            <div class="icon">‚öôÔ∏è</div>
                            <div class="label">Personalizado</div>
                        </div>
                    </div>
                    <div class="report-date-range" id="customDateRange" style="display: none; margin-top: 16px;">
                        <div class="form-group">
                            <label>Data In√≠cio</label>
                            <input type="date" id="reportDateStart">
                        </div>
                        <div class="form-group">
                            <label>Data Fim</label>
                            <input type="date" id="reportDateEnd">
                        </div>
                    </div>
                </div>

                <!-- Dispositivo -->
                <div class="report-section">
                    <h4>Dispositivo</h4>
                    <select class="device-select" id="reportDevice">
                        <option value="all">üìç Todos os dispositivos (Consolidado)</option>
                    </select>
                </div>

                <!-- Conte√∫do -->
                <div class="report-section">
                    <h4>Incluir no Relat√≥rio</h4>
                    <div class="report-checkboxes">
                        <div class="report-checkbox">
                            <input type="checkbox" id="chkSummary" checked>
                            <label for="chkSummary">Resumo (m√©dia, m√°x, m√≠n, total)</label>
                        </div>
                        <div class="report-checkbox">
                            <input type="checkbox" id="chkChart" checked>
                            <label for="chkChart">Gr√°fico de evolu√ß√£o</label>
                        </div>
                        <div class="report-checkbox">
                            <input type="checkbox" id="chkTable" checked>
                            <label for="chkTable">Tabela de leituras</label>
                        </div>
                        <div class="report-checkbox">
                            <input type="checkbox" id="chkAlerts" checked>
                            <label for="chkAlerts">Alertas e anomalias</label>
                        </div>
                        <div class="report-checkbox">
                            <input type="checkbox" id="chkOperation" checked>
                            <label for="chkOperation">Tempo de opera√ß√£o</label>
                        </div>
                    </div>
                </div>

                <!-- Formato -->
                <div class="report-section">
                    <h4>Formato de Exporta√ß√£o</h4>
                    <div class="report-options" id="formatOptions">
                        <div class="report-option selected" data-format="pdf" onclick="selectFormat('pdf')">
                            <div class="icon">üìÑ</div>
                            <div class="label">PDF</div>
                        </div>
                        <div class="report-option" data-format="excel" onclick="selectFormat('excel')">
                            <div class="icon">üìä</div>
                            <div class="label">Excel</div>
                        </div>
                        <div class="report-option" data-format="csv" onclick="selectFormat('csv')">
                            <div class="icon">üìù</div>
                            <div class="label">CSV</div>
                        </div>
                        <div class="report-option" data-format="preview" onclick="selectFormat('preview')">
                            <div class="icon">üëÅÔ∏è</div>
                            <div class="label">Visualizar</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="report-modal-footer">
                <button class="btn-cancel" onclick="closeReportModal()">Cancelar</button>
                <button class="btn-generate" id="btnGenerate" onclick="generateReport()">
                    üìÑ Gerar Relat√≥rio
                </button>
            </div>
        </div>
    </div>

    <!-- Report Preview -->
    <div class="report-preview" id="reportPreview">
        <div class="report-preview-actions">
            <button class="btn-generate" onclick="downloadReportPDF()">üì• Baixar PDF</button>
            <button class="btn-generate" onclick="downloadReportExcel()">üìä Baixar Excel</button>
            <button class="btn-cancel" onclick="closeReportPreview()">‚úï Fechar</button>
        </div>
        <div class="report-container" id="reportContent">
            <!-- Report content will be generated here -->
        </div>
    </div>

    <!-- Device Config Modal -->
    <div class="config-modal" id="configModal">
        <div class="config-modal-content">
            <div class="config-modal-header">
                <h3>‚öôÔ∏è Configurar Dispositivo</h3>
                <button class="btn-close" onclick="closeConfigModal()">√ó</button>
            </div>
            <div class="config-modal-body">
                <div id="configStatus" class="config-status not-configured">
                    <span class="icon">‚ö†Ô∏è</span>
                    <span class="text">Dispositivo n√£o configurado</span>
                </div>

                <div class="config-group">
                    <label>Vaz√£o Nominal (Comum)</label>
                    <div class="config-input-wrapper">
                        <input type="number" id="configVazaoNominal" placeholder="Ex: 50.00" step="0.01">
                        <span class="unit">m¬≥/h</span>
                    </div>
                    <div class="hint">Vaz√£o normal de opera√ß√£o. O sistema considera "ligado" quando a vaz√£o √© ‚â• 50% deste valor.</div>
                </div>

                <div class="config-group">
                    <label>Alerta M√≠nimo</label>
                    <div class="config-input-wrapper">
                        <input type="number" id="configAlertaMinimo" placeholder="Ex: 10.00" step="0.01">
                        <span class="unit">m¬≥/h</span>
                    </div>
                    <div class="hint">Gera alerta quando a vaz√£o cair abaixo deste valor (exceto quando desligado).</div>
                </div>

                <div class="config-group">
                    <label>Alerta M√°ximo</label>
                    <div class="config-input-wrapper">
                        <input type="number" id="configAlertaMaximo" placeholder="Ex: 80.00" step="0.01">
                        <span class="unit">m¬≥/h</span>
                    </div>
                    <div class="hint">Gera alerta quando a vaz√£o ultrapassar este valor.</div>
                </div>

                <div class="config-group">
                    <label>Intervalo entre Leituras</label>
                    <div class="config-input-wrapper">
                        <input type="number" id="configIntervalo" placeholder="1" value="1" min="1">
                        <span class="unit">min</span>
                    </div>
                    <div class="hint">Tempo entre cada leitura. Usado para calcular volume total acumulado.</div>
                </div>
            </div>
            <div class="config-modal-footer">
                <button class="btn-cancel" onclick="closeConfigModal()">Cancelar</button>
                <button class="btn-generate" onclick="saveDeviceConfig()">üíæ Salvar</button>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // ==================== CONFIGURA√á√ÉO ====================
        const SUPABASE_URL = 'https://ddrbyexthwzkmmeigpql.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkcmJ5ZXh0aHd6a21tZWlncHFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4OTMxNTgsImV4cCI6MjA4MTQ2OTE1OH0.vMtwNQ3a4--wWMNz734u4KB6sdYQbZ727HRovNZHHAE';
        const ISSO_API_BASE = 'https://datalog.issodns.com/data';

        // ==================== INICIALIZA√á√ÉO ====================
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let map = null;
        let markers = {};
        let currentUser = null;
        let currentFazenda = null;
        let dispositivos = [];
        let dadosDispositivos = {};
        let unidadeAtual = 'm3h'; // m3h ou ls
        let selectedDevice = null;

        // ==================== ELEMENTOS DOM ====================
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loginContainer = document.getElementById('loginContainer');
        const dashboard = document.getElementById('dashboard');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const fazendaNome = document.getElementById('fazendaNome');
        const deviceList = document.getElementById('deviceList');
        const detailPanel = document.getElementById('detailPanel');
        const toast = document.getElementById('toast');

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
        });

        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            
            if (session) {
                currentUser = session.user;
                await loadUserData();
                showDashboard();
            } else {
                hideLoading();
            }

            // Listen for auth changes
            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_IN' && session) {
                    currentUser = session.user;
                    await loadUserData();
                    showDashboard();
                } else if (event === 'SIGNED_OUT') {
                    showLogin();
                }
            });
        }

        // ==================== AUTH ====================
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');

            btn.disabled = true;
            btn.textContent = 'Entrando...';
            loginError.classList.remove('show');

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) throw error;

            } catch (error) {
                loginError.textContent = 'Email ou senha incorretos';
                loginError.classList.add('show');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Entrar';
            }
        });

        document.getElementById('btnLogout').addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
        });

        // ==================== LOAD DATA ====================
        async function loadUserData() {
            try {
                // Load user profile with role
                const { data: perfil, error: perfilError } = await supabaseClient
                    .from('perfis')
                    .select('*, fazendas(*), roles(*)')
                    .eq('id', currentUser.id)
                    .single();

                if (perfilError) throw perfilError;

                // Check if admin (nivel >= 3 or is_admin = true)
                const isAdmin = perfil.is_admin || (perfil.roles?.nivel >= 3);
                if (isAdmin) {
                    document.getElementById('btnAdmin').style.display = 'block';
                }

                if (!perfil.fazenda_id) {
                    // Se n√£o tem fazenda vinculada, buscar a primeira dispon√≠vel
                    const { data: fazendas } = await supabaseClient
                        .from('fazendas')
                        .select('*')
                        .limit(1);
                    
                    if (fazendas && fazendas.length > 0) {
                        currentFazenda = fazendas[0];
                    } else {
                        showToast('Nenhuma fazenda dispon√≠vel', 'error');
                        return;
                    }
                } else {
                    currentFazenda = perfil.fazendas;
                }
                
                fazendaNome.textContent = currentFazenda.nome;

                // Load devices
                const { data: devs, error: devsError } = await supabaseClient
                    .from('dispositivos')
                    .select('*')
                    .eq('fazenda_id', currentFazenda.id)
                    .eq('ativo', true);

                if (devsError) throw devsError;

                dispositivos = devs;

                // Load data from ISSO API
                await loadDevicesData();

            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Erro ao carregar dados', 'error');
            }
        }

        async function loadDevicesData() {
            showLoading();

            for (const device of dispositivos) {
                try {
                    // Buscar √∫ltimas 6 horas (para gr√°fico com hist√≥rico razo√°vel)
                    // ~360 registros por dispositivo
                    const { data: leiturasDB, error: dbError } = await supabaseClient
                        .from('leituras')
                        .select('timestamp, valor, valor_sensor')
                        .eq('dispositivo_id', device.id)
                        .gte('timestamp', new Date(Date.now() - 6 * 60 * 60 * 1000).toISOString())
                        .order('timestamp', { ascending: true });

                    if (leiturasDB && leiturasDB.length > 0) {
                        // Converter formato do Supabase para formato esperado
                        dadosDispositivos[device.id] = leiturasDB.map(l => ({
                            inicioperiodo: new Date(l.timestamp).toLocaleString('sv-SE').replace('T', ' ').slice(0, 19),
                            fuso: -180,
                            valor_convertido0: parseFloat(l.valor),
                            valor_sensor0: parseFloat(l.valor_sensor || l.valor)
                        }));
                        console.log(`Loaded ${leiturasDB.length} readings for ${device.nome}`);
                    } else {
                        dadosDispositivos[device.id] = [];
                    }
                } catch (error) {
                    console.error(`Error loading device ${device.id}:`, error);
                    dadosDispositivos[device.id] = [];
                }
            }

            renderDevices();
            initMap();
            updateTimestamp();
            hideLoading();
        }

        // Fun√ß√£o para for√ßar sincroniza√ß√£o via Edge Function
        async function refreshFromAPI() {
            showLoading();

            try {
                // Chamar Edge Function para sincronizar
                const response = await fetch(
                    'https://ddrbyexthwzkmmeigpql.supabase.co/functions/v1/sync-isso-data',
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                const result = await response.json();
                console.log('Sync result:', result);

                if (!result.success) {
                    throw new Error(result.error || 'Erro na sincroniza√ß√£o');
                }

                // Recarregar dados do Supabase
                await loadDevicesData();
                
                return result.resultados?.filter(r => r.status === 'ok').length || 0;

            } catch (error) {
                console.error('Erro ao sincronizar:', error);
                
                // Fallback: tentar buscar direto da API (caso Edge Function n√£o esteja configurada)
                console.log('Tentando fallback direto da API...');
                return await refreshFromAPIDirectFallback();
            }
        }

        // Fallback: buscar direto da API (para quando Edge Function n√£o estiver pronta)
        async function refreshFromAPIDirectFallback() {
            let totalNovas = 0;

            for (const device of dispositivos) {
                try {
                    const sid = device.sid || 'RR2NDLLWT9IQ';
                    const widgetId = device.widget_id || '1421441';
                    
                    const response = await fetch(
                        `${ISSO_API_BASE}/?Widget=${widgetId}&Aba=2&Time=-180&sid=${sid}`
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        const widgetData = data[widgetId];
                        
                        if (widgetData && widgetData.Valores && widgetData.Valores.length > 0) {
                            const valorStr = widgetData.Valores[0].Valor;
                            const valor = parseFloat(valorStr.replace(',', '.'));
                            const timestamp = new Date().toISOString();
                            
                            const { error } = await supabaseClient
                                .from('leituras')
                                .insert({
                                    dispositivo_id: device.id,
                                    timestamp: timestamp,
                                    valor: valor,
                                    valor_sensor: valor,
                                    unidade: device.unidade || 'm3h'
                                });

                            if (!error) totalNovas++;
                            console.log(`Device ${device.nome}: ${valor} m¬≥/h`);
                        }
                    }
                } catch (error) {
                    console.error(`Error refreshing device ${device.id}:`, error);
                }
            }

            await loadDevicesData();
            return totalNovas;
        }

        // ==================== RENDER ====================
        function renderDevices() {
            deviceList.innerHTML = dispositivos.map(device => {
                const dados = dadosDispositivos[device.id];
                const ultimoRegistro = dados && dados.length > 0 ? dados[dados.length - 1] : null;
                const valor = ultimoRegistro ? ultimoRegistro.valor_convertido0 : null;
                const valorExibir = formatValue(valor);
                const unidade = unidadeAtual === 'm3h' ? 'm¬≥/h' : 'L/s';
                const online = ultimoRegistro !== null;
                const timestamp = ultimoRegistro ? ultimoRegistro.inicioperiodo : '--';
                const isConfigured = device.vazao_nominal !== null && device.vazao_nominal !== undefined;

                return `
                    <div class="device-card ${selectedDevice === device.id ? 'selected' : ''}" 
                         data-id="${device.id}" onclick="selectDevice('${device.id}')">
                        <div class="device-header">
                            <div class="device-name-container">
                                <div class="device-name">
                                    <input type="text" value="${device.nome}" 
                                           onchange="updateDeviceName('${device.id}', this.value)"
                                           onclick="event.stopPropagation()">
                                </div>
                                <div class="device-location">üìç ${device.descricao || 'Sem descri√ß√£o'}</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <button class="btn-config" onclick="event.stopPropagation(); openConfigModal('${device.id}')" title="Configurar">
                                    ‚öôÔ∏è ${isConfigured ? '‚úì' : ''}
                                </button>
                                <span class="device-status ${online ? 'online' : 'offline'}">
                                    ${online ? 'Online' : 'Offline'}
                                </span>
                            </div>
                        </div>
                        <div class="device-value">
                            <span class="value">${valorExibir !== null ? valorExibir : '--'}</span>
                            <span class="unit">${unidade}</span>
                            <div class="timestamp">${timestamp}</div>
                        </div>
                        <div class="device-chart">
                            <canvas id="chart-${device.id}" width="100%" height="80"></canvas>
                        </div>
                    </div>
                `;
            }).join('');

            // Render mini charts
            dispositivos.forEach(device => {
                const dados = dadosDispositivos[device.id];
                if (dados && dados.length > 0) {
                    renderMiniChart(device.id, dados);
                }
            });
        }

        function formatValue(valor) {
            if (valor === null || valor === undefined) return null;
            
            if (unidadeAtual === 'ls') {
                // Converter m¬≥/h para L/s: dividir por 3.6
                return (valor / 3.6).toFixed(3);
            }
            // Manter 3 casas decimais (padr√£o da API)
            return valor.toFixed(3);
        }

        function renderMiniChart(deviceId, dados) {
            const canvas = document.getElementById(`chart-${deviceId}`);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = 80;

            const values = dados.map(d => d.valor_convertido0);
            const min = Math.min(...values);
            const max = Math.max(...values);
            const range = max - min || 1;

            // Draw line
            ctx.beginPath();
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 2;

            values.forEach((val, i) => {
                const x = (i / (values.length - 1)) * canvas.width;
                const y = canvas.height - ((val - min) / range) * (canvas.height - 20) - 10;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });

            ctx.stroke();

            // Fill area
            ctx.lineTo(canvas.width, canvas.height);
            ctx.lineTo(0, canvas.height);
            ctx.closePath();
            
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.3)');
            gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');
            ctx.fillStyle = gradient;
            ctx.fill();
        }

        // ==================== MAP ====================
        function initMap() {
            console.log('>>> initMap() chamada');
            
            const mapContainer = document.getElementById('map');
            
            // Destruir mapa anterior se existir
            if (map) {
                try {
                    map.remove();
                } catch(e) {
                    console.log('Erro ao remover mapa:', e);
                }
                map = null;
            }
            
            // Limpar container
            mapContainer.innerHTML = '';
            
            // Pegar coordenadas do primeiro dispositivo com localiza√ß√£o
            let centerLat = -25.4284;
            let centerLng = -54.5934;
            let zoom = 10;
            
            const deviceWithCoords = dispositivos.find(d => d.latitude && d.longitude);
            
            if (deviceWithCoords) {
                centerLat = parseFloat(deviceWithCoords.latitude);
                centerLng = parseFloat(deviceWithCoords.longitude);
                zoom = 15;
                console.log('>>> Centralizando em:', centerLat, centerLng);
            }
            
            // Criar mapa
            map = L.map(mapContainer, {
                center: [centerLat, centerLng],
                zoom: zoom
            });

            // Camadas de mapa
            const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            });

            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '¬© Esri'
            });

            const hybridLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '¬© Esri'
            });

            // Labels para o modo h√≠brido
            const labelsLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                opacity: 0.4
            });

            // Adicionar camada padr√£o (sat√©lite)
            satelliteLayer.addTo(map);

            // Controle de camadas
            const baseMaps = {
                "üõ∞Ô∏è Sat√©lite": satelliteLayer,
                "üó∫Ô∏è Ruas": streetLayer
            };

            L.control.layers(baseMaps, null, { position: 'topright' }).addTo(map);

            // Adicionar marcadores
            dispositivos.forEach(device => {
                if (device.latitude && device.longitude) {
                    addMarker(device);
                }
            });
            
            // For√ßar resize ap√≥s um momento
            setTimeout(() => {
                map.invalidateSize();
            }, 200);
            
            console.log('>>> initMap() finalizada');
        }

        function addMarker(device) {
            const dados = dadosDispositivos[device.id];
            const ultimoRegistro = dados && dados.length > 0 ? dados[dados.length - 1] : null;
            const valor = ultimoRegistro ? ultimoRegistro.valor_convertido0 : null;
            const valorExibir = formatValue(valor);
            const unidade = unidadeAtual === 'm3h' ? 'm¬≥/h' : 'L/s';

            const icon = L.divIcon({
                className: 'custom-marker-container',
                html: `<div class="custom-marker" style="background: ${device.cor_marker || '#3b82f6'}">üíß</div>`,
                iconSize: [36, 36],
                iconAnchor: [18, 18]
            });

            const marker = L.marker([device.latitude, device.longitude], { icon })
                .addTo(map)
                .bindPopup(`
                    <div class="popup-content">
                        <h4>${device.nome}</h4>
                        <div class="value">${valorExibir !== null ? valorExibir : '--'}</div>
                        <div class="unit">${unidade}</div>
                    </div>
                `);

            marker.on('click', () => selectDevice(device.id));

            markers[device.id] = marker;
        }

        // ==================== DEVICE SELECTION ====================
        function selectDevice(deviceId) {
            selectedDevice = deviceId;
            renderDevices();
            showDetailPanel(deviceId);

            // Center map on device
            const device = dispositivos.find(d => d.id === deviceId);
            if (device && device.latitude && device.longitude) {
                map.setView([device.latitude, device.longitude], 14);
                markers[deviceId].openPopup();
            }
        }

        function showDetailPanel(deviceId) {
            const device = dispositivos.find(d => d.id === deviceId);
            const dados = dadosDispositivos[deviceId];
            
            if (!device) return;

            document.getElementById('detailTitle').textContent = device.nome;

            // Stats
            const ultimoRegistro = dados && dados.length > 0 ? dados[dados.length - 1] : null;
            const valor = ultimoRegistro ? ultimoRegistro.valor_convertido0 : null;
            const valores = dados ? dados.map(d => d.valor_convertido0) : [];
            const media = valores.length > 0 ? valores.reduce((a, b) => a + b, 0) / valores.length : 0;
            const max = valores.length > 0 ? Math.max(...valores) : 0;
            const min = valores.length > 0 ? Math.min(...valores) : 0;

            document.getElementById('detailStats').innerHTML = `
                <div class="stat-card">
                    <div class="label">Atual</div>
                    <div class="value" style="color: var(--accent-cyan)">${formatValue(valor) || '--'}</div>
                </div>
                <div class="stat-card">
                    <div class="label">M√©dia (1h)</div>
                    <div class="value">${formatValue(media)}</div>
                </div>
                <div class="stat-card">
                    <div class="label">M√°ximo</div>
                    <div class="value" style="color: var(--accent-green)">${formatValue(max)}</div>
                </div>
                <div class="stat-card">
                    <div class="label">M√≠nimo</div>
                    <div class="value" style="color: var(--accent-yellow)">${formatValue(min)}</div>
                </div>
            `;

            // Chart
            renderDetailChart(dados);

            // Table
            const tableBody = document.getElementById('detailTableBody');
            const ultimosRegistros = dados ? dados.slice(-10).reverse() : [];
            tableBody.innerHTML = ultimosRegistros.map(reg => `
                <tr>
                    <td class="mono">${reg.inicioperiodo.split(' ')[1]}</td>
                    <td class="mono">${formatValue(reg.valor_convertido0)} ${unidadeAtual === 'm3h' ? 'm¬≥/h' : 'L/s'}</td>
                </tr>
            `).join('');

            detailPanel.classList.add('active');
        }

        function renderDetailChart(dados) {
            const canvas = document.getElementById('detailChart');
            const ctx = canvas.getContext('2d');
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = 200;

            if (!dados || dados.length === 0) {
                ctx.fillStyle = '#64748b';
                ctx.font = '14px Plus Jakarta Sans';
                ctx.textAlign = 'center';
                ctx.fillText('Sem dados dispon√≠veis', canvas.width / 2, canvas.height / 2);
                return;
            }

            const values = dados.map(d => d.valor_convertido0);
            const min = Math.min(...values) * 0.9;
            const max = Math.max(...values) * 1.1;
            const range = max - min || 1;

            // Draw grid
            ctx.strokeStyle = 'rgba(255,255,255,0.05)';
            ctx.lineWidth = 1;
            for (let i = 0; i < 5; i++) {
                const y = (canvas.height / 5) * i + 20;
                ctx.beginPath();
                ctx.moveTo(40, y);
                ctx.lineTo(canvas.width - 10, y);
                ctx.stroke();
            }

            // Draw line
            ctx.beginPath();
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 2;

            values.forEach((val, i) => {
                const x = 40 + (i / (values.length - 1)) * (canvas.width - 50);
                const y = canvas.height - 30 - ((val - min) / range) * (canvas.height - 60);
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });

            ctx.stroke();

            // Fill area
            ctx.lineTo(canvas.width - 10, canvas.height - 30);
            ctx.lineTo(40, canvas.height - 30);
            ctx.closePath();
            
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.3)');
            gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');
            ctx.fillStyle = gradient;
            ctx.fill();

            // Y axis labels
            ctx.fillStyle = '#64748b';
            ctx.font = '11px JetBrains Mono';
            ctx.textAlign = 'right';
            for (let i = 0; i <= 4; i++) {
                const val = min + (range * (4 - i) / 4);
                const y = (canvas.height / 5) * i + 24;
                ctx.fillText(val.toFixed(1), 35, y);
            }
        }

        document.getElementById('btnCloseDetail').addEventListener('click', () => {
            detailPanel.classList.remove('active');
            selectedDevice = null;
            renderDevices();
        });

        // ==================== UNIT TOGGLE ====================
        document.querySelectorAll('.unit-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.unit-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                unidadeAtual = btn.dataset.unit;
                renderDevices();
                
                // Update markers
                dispositivos.forEach(device => {
                    if (markers[device.id]) {
                        const dados = dadosDispositivos[device.id];
                        const ultimoRegistro = dados && dados.length > 0 ? dados[dados.length - 1] : null;
                        const valor = ultimoRegistro ? ultimoRegistro.valor_convertido0 : null;
                        const valorExibir = formatValue(valor);
                        const unidade = unidadeAtual === 'm3h' ? 'm¬≥/h' : 'L/s';
                        
                        markers[device.id].setPopupContent(`
                            <div class="popup-content">
                                <h4>${device.nome}</h4>
                                <div class="value">${valorExibir !== null ? valorExibir : '--'}</div>
                                <div class="unit">${unidade}</div>
                            </div>
                        `);
                    }
                });

                // Update detail panel if open
                if (selectedDevice) {
                    showDetailPanel(selectedDevice);
                }
            });
        });

        // ==================== REFRESH ====================
        document.getElementById('btnRefresh').addEventListener('click', async () => {
            const btn = document.getElementById('btnRefresh');
            btn.classList.add('loading');
            btn.innerHTML = '<span>‚è≥</span> Buscando da API...';

            try {
                const novas = await refreshFromAPI();
                showToast(`Dados atualizados! ${novas} registros salvos.`, 'success');
            } catch (error) {
                console.error('Refresh error:', error);
                showToast('Erro ao atualizar dados', 'error');
            }

            btn.classList.remove('loading');
            btn.innerHTML = '<span>‚Üª</span> Atualizar Dados';
        });

        function updateTimestamp() {
            const now = new Date();
            document.getElementById('ultimaAtualizacao').textContent = 
                `√öltima atualiza√ß√£o: ${now.toLocaleTimeString('pt-BR')}`;
        }

        // ==================== UPDATE DEVICE NAME ====================
        async function updateDeviceName(deviceId, newName) {
            try {
                const { error } = await supabaseClient
                    .from('dispositivos')
                    .update({ nome: newName })
                    .eq('id', deviceId);

                if (error) throw error;

                // Update local data
                const device = dispositivos.find(d => d.id === deviceId);
                if (device) {
                    device.nome = newName;
                }

                // Update marker popup
                if (markers[deviceId]) {
                    const dados = dadosDispositivos[deviceId];
                    const ultimoRegistro = dados && dados.length > 0 ? dados[dados.length - 1] : null;
                    const valor = ultimoRegistro ? ultimoRegistro.valor_convertido0 : null;
                    const valorExibir = formatValue(valor);
                    const unidade = unidadeAtual === 'm3h' ? 'm¬≥/h' : 'L/s';
                    
                    markers[deviceId].setPopupContent(`
                        <div class="popup-content">
                            <h4>${newName}</h4>
                            <div class="value">${valorExibir !== null ? valorExibir : '--'}</div>
                            <div class="unit">${unidade}</div>
                        </div>
                    `);
                }

                showToast('Nome atualizado', 'success');
            } catch (error) {
                console.error('Error updating name:', error);
                showToast('Erro ao atualizar nome', 'error');
            }
        }

        // ==================== UI HELPERS ====================
        function showDashboard() {
            loginContainer.classList.add('hidden');
            dashboard.classList.add('active');
            hideLoading();
        }

        function showLogin() {
            loginContainer.classList.remove('hidden');
            dashboard.classList.remove('active');
            hideLoading();
        }

        function showLoading() {
            loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        function showToast(message, type = 'success') {
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Make functions available globally
        window.selectDevice = selectDevice;
        window.updateDeviceName = updateDeviceName;
        window.openConfigModal = openConfigModal;
        window.closeConfigModal = closeConfigModal;
        window.saveDeviceConfig = saveDeviceConfig;

        // ==================== DEVICE CONFIGURATION ====================
        let currentConfigDevice = null;

        function openConfigModal(deviceId) {
            currentConfigDevice = dispositivos.find(d => d.id === deviceId);
            if (!currentConfigDevice) return;

            // Fill form with current values
            document.getElementById('configVazaoNominal').value = currentConfigDevice.vazao_nominal || '';
            document.getElementById('configAlertaMinimo').value = currentConfigDevice.alerta_minimo || '';
            document.getElementById('configAlertaMaximo').value = currentConfigDevice.alerta_maximo || '';
            document.getElementById('configIntervalo').value = currentConfigDevice.intervalo_leitura || 1;

            // Update status
            const statusEl = document.getElementById('configStatus');
            if (currentConfigDevice.vazao_nominal) {
                statusEl.className = 'config-status configured';
                statusEl.innerHTML = `<span class="icon">‚úÖ</span><span class="text">Dispositivo configurado - Vaz√£o nominal: ${currentConfigDevice.vazao_nominal} m¬≥/h</span>`;
            } else {
                statusEl.className = 'config-status not-configured';
                statusEl.innerHTML = `<span class="icon">‚ö†Ô∏è</span><span class="text">Dispositivo n√£o configurado - Configure a vaz√£o nominal para c√°lculos precisos</span>`;
            }

            document.getElementById('configModal').classList.add('active');
        }

        function closeConfigModal() {
            document.getElementById('configModal').classList.remove('active');
            currentConfigDevice = null;
        }

        async function saveDeviceConfig() {
            if (!currentConfigDevice) return;

            const vazaoNominal = parseFloat(document.getElementById('configVazaoNominal').value) || null;
            const alertaMinimo = parseFloat(document.getElementById('configAlertaMinimo').value) || null;
            const alertaMaximo = parseFloat(document.getElementById('configAlertaMaximo').value) || null;
            const intervaloLeitura = parseInt(document.getElementById('configIntervalo').value) || 1;

            try {
                const { error } = await supabaseClient
                    .from('dispositivos')
                    .update({
                        vazao_nominal: vazaoNominal,
                        alerta_minimo: alertaMinimo,
                        alerta_maximo: alertaMaximo,
                        intervalo_leitura: intervaloLeitura
                    })
                    .eq('id', currentConfigDevice.id);

                if (error) throw error;

                // Update local data
                const deviceIndex = dispositivos.findIndex(d => d.id === currentConfigDevice.id);
                if (deviceIndex !== -1) {
                    dispositivos[deviceIndex].vazao_nominal = vazaoNominal;
                    dispositivos[deviceIndex].alerta_minimo = alertaMinimo;
                    dispositivos[deviceIndex].alerta_maximo = alertaMaximo;
                    dispositivos[deviceIndex].intervalo_leitura = intervaloLeitura;
                }

                showToast('Configura√ß√£o salva com sucesso!', 'success');
                closeConfigModal();
                renderDevices();

            } catch (error) {
                console.error('Error saving config:', error);
                showToast('Erro ao salvar configura√ß√£o', 'error');
            }
        }

        // ==================== REPORT SYSTEM ====================
        const LOGO_BASE64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAS0AAACnCAYAAABEvwrkAAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAABLaADAAQAAAABAAAApwAAAABSrBuCAAAq1UlEQVR4Ae19CZwU1bX36VmZYRkYdkEcFBBxi1ER3AK4RDRGP5e8qCDx5XsaE3zGJAqaCIImonHBCL8Y3/eLccHdzxgU44IgPEEN6hNEUZB1gGGZgWGbvfud/6k+PTVNd1EzIt4ez4Weqq67nfu/t/51zrm3bkem3nd/7MijjyILhoAhYAi4jsDSJZ9QDgjrzDPPdF1Wk88QMAQMAUEgR3GIxWJ6akdDwBAwBJxDIBKJiExZzklmAhkChoAhEICAkVYAOBZlCBgC7iFgpOVen5hEhoAhEICAkVYAOBZlCBgC7iFgpOVen5hEhoAhEICAkVYAOBZlCBgC7iFgpOVen5hEhoAhEICAkVYAOBZlCBgC7iFgpOVen5hEhoAhEICAkVYAOBZlCBgC7iFgpOVen5hEhoAhEICAkVYAOBZlCBgC7iFgpOVen5hEhoAhEICAkVYAOBZlCBgC7iFgpOVen5hEhoAhEICAkVYAOBZlCBgC7iFgpOVen5hEhoAhEICAkVYAOBZlCBgC7iFgpOVen5hEhoAhEICAkVYAOBZlCBgC7iFgpOVen5hEhoAhEICAkVYAOBZlCBgC7iFgpOVen5hEhoAhEICAkVYAOBZlCBgC7iFgpOVen5hEhoAhEICAkVYAOBZlCBgC7iFgpOVen5hEhoAhEICAkVYAOBZlCBgC7iFgpOVen5hEhoAhEICAkVYAOBZlCBgC7iFgpOVen5hEhoAhEICAkVYAOBZlCBgC7iFgpOVen5hEhoAhEICAkVYAOBZlCBgC7iFgpOVen5hEhoAhEICAkVYAOBZlCBgC7iFgpOVen5hEhoAhEICAkVYAOBZlCBgC7iFgpOVen5hEhoAhEICAkVYAOBZlCBgC7iFgpOVen5hEhoAhEICAkVYAOBZlCBgC7iFgpOVen5hEhoAhEICAkVYAOBZlCBgC7iFgpOVen5hEhoAhEICAkVYAOBZlCBgC7iFgpOVen5hEhoAhEICAkVYAOBZlCBgC7iFgpOVen5hEhoAhEICAkVYAOBZlCBgC7iFgpOVen5hEhoAhEIBAjnZmJBLRUzsaAoaAIeAsAjmLS5c6K5wJZggYAoaAHwHw1f/aTrmUOxPgRwRg/f/pJf9jrSYA+L9JREAAAABJRU5ErkJggg==';

        let reportConfig = {
            period: null,
            dateStart: null,
            dateEnd: null,
            device: 'all',
            format: 'pdf',
            includeSummary: true,
            includeChart: true,
            includeTable: true,
            includeAlerts: true,
            includeOperation: true
        };

        // Open report modal
        document.getElementById('btnReport').addEventListener('click', () => {
            // Populate device select
            const select = document.getElementById('reportDevice');
            select.innerHTML = '<option value="all">üìç Todos os dispositivos (Consolidado)</option>';
            dispositivos.forEach(d => {
                select.innerHTML += `<option value="${d.id}">${d.nome}</option>`;
            });

            // Set default dates
            const today = new Date();
            const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            document.getElementById('reportDateEnd').value = today.toISOString().split('T')[0];
            document.getElementById('reportDateStart').value = lastWeek.toISOString().split('T')[0];

            document.getElementById('reportModal').classList.add('active');
        });

        function closeReportModal() {
            document.getElementById('reportModal').classList.remove('active');
        }

        function selectPeriod(period) {
            document.querySelectorAll('#periodOptions .report-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`[data-period="${period}"]`).classList.add('selected');
            reportConfig.period = period;

            // Show/hide custom date range
            document.getElementById('customDateRange').style.display = 
                period === 'custom' ? 'grid' : 'none';
        }

        function selectFormat(format) {
            document.querySelectorAll('#formatOptions .report-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`[data-format="${format}"]`).classList.add('selected');
            reportConfig.format = format;
        }

        async function generateReport() {
            const btn = document.getElementById('btnGenerate');
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Gerando...';

            try {
                // Get config
                reportConfig.device = document.getElementById('reportDevice').value;
                reportConfig.includeSummary = document.getElementById('chkSummary').checked;
                reportConfig.includeChart = document.getElementById('chkChart').checked;
                reportConfig.includeTable = document.getElementById('chkTable').checked;
                reportConfig.includeAlerts = document.getElementById('chkAlerts').checked;
                reportConfig.includeOperation = document.getElementById('chkOperation').checked;

                // Calculate date range
                const today = new Date();
                let startDate, endDate = today;

                switch(reportConfig.period) {
                    case 'day':
                        startDate = new Date(today.setHours(0, 0, 0, 0));
                        endDate = new Date();
                        break;
                    case 'week':
                        startDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                        break;
                    case 'month':
                        startDate = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                        break;
                    case 'custom':
                        startDate = new Date(document.getElementById('reportDateStart').value);
                        endDate = new Date(document.getElementById('reportDateEnd').value);
                        break;
                    default:
                        startDate = new Date(today.getTime() - 24 * 60 * 60 * 1000);
                }

                reportConfig.dateStart = startDate;
                reportConfig.dateEnd = endDate;

                // Get data from Supabase
                let reportData = await getReportData(reportConfig);

                // Generate based on format
                switch(reportConfig.format) {
                    case 'preview':
                        renderReportPreview(reportData);
                        break;
                    case 'pdf':
                        await generatePDF(reportData);
                        break;
                    case 'excel':
                        generateExcel(reportData);
                        break;
                    case 'csv':
                        generateCSV(reportData);
                        break;
                }

                closeReportModal();
                showToast('Relat√≥rio gerado com sucesso!', 'success');

            } catch (error) {
                console.error('Error generating report:', error);
                showToast('Erro ao gerar relat√≥rio', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üìÑ Gerar Relat√≥rio';
            }
        }

        async function getReportData(config) {
            let devicesToReport = config.device === 'all' 
                ? dispositivos 
                : dispositivos.filter(d => d.id === config.device);

            let reportData = {
                fazenda: currentFazenda,
                periodo: {
                    inicio: config.dateStart,
                    fim: config.dateEnd
                },
                dispositivos: [],
                geradoEm: new Date()
            };

            for (const device of devicesToReport) {
                const { data: leituras, error } = await supabaseClient
                    .from('leituras')
                    .select('*')
                    .eq('dispositivo_id', device.id)
                    .gte('timestamp', config.dateStart.toISOString())
                    .lte('timestamp', config.dateEnd.toISOString())
                    .order('timestamp', { ascending: true });

                if (error) {
                    console.error('Error fetching data:', error);
                    continue;
                }

                const valores = leituras.map(l => parseFloat(l.valor));
                const total = valores.reduce((a, b) => a + b, 0);
                const media = valores.length > 0 ? total / valores.length : 0;
                const max = valores.length > 0 ? Math.max(...valores) : 0;
                const min = valores.length > 0 ? Math.min(...valores) : 0;

                // Get device configuration
                const vazaoNominal = device.vazao_nominal || media; // Use average if not configured
                const limiteOperacao = vazaoNominal * 0.5; // 50% of nominal
                const intervaloMinutos = device.intervalo_leitura || 1;
                const alertaMinimo = device.alerta_minimo;
                const alertaMaximo = device.alerta_maximo;

                // Calculate operation time (when value >= 50% of nominal)
                let operationMinutes = 0;
                leituras.forEach(l => {
                    if (parseFloat(l.valor) >= limiteOperacao) {
                        operationMinutes += intervaloMinutos;
                    }
                });

                // Calculate total volume (m¬≥)
                // Volume = Œ£(vaz√£o √ó intervalo em horas)
                // vaz√£o em m¬≥/h, intervalo em minutos = vaz√£o √ó (intervalo/60)
                let totalVolume = 0;
                leituras.forEach(l => {
                    const vazao = parseFloat(l.valor);
                    // Only count if "operating" (>= 50% of nominal)
                    if (vazao >= limiteOperacao) {
                        totalVolume += vazao * (intervaloMinutos / 60);
                    }
                });

                // Detect alerts based on device configuration
                let alerts = [];
                for (let i = 0; i < leituras.length; i++) {
                    const current = parseFloat(leituras[i].valor);
                    const timestamp = leituras[i].timestamp;
                    
                    // Check maximum alert
                    if (alertaMaximo !== null && current > alertaMaximo) {
                        alerts.push({
                            type: 'critical',
                            timestamp: timestamp,
                            message: `Vaz√£o acima do limite: ${current.toFixed(1)} m¬≥/h (m√°x: ${alertaMaximo} m¬≥/h)`
                        });
                    }
                    
                    // Check minimum alert (only if device is "on")
                    if (alertaMinimo !== null && current >= limiteOperacao && current < alertaMinimo) {
                        alerts.push({
                            type: 'warning',
                            timestamp: timestamp,
                            message: `Vaz√£o abaixo do limite: ${current.toFixed(1)} m¬≥/h (m√≠n: ${alertaMinimo} m¬≥/h)`
                        });
                    }

                    // Check sudden drops (more than 50% in one reading)
                    if (i > 0) {
                        const previous = parseFloat(leituras[i-1].valor);
                        if (previous >= limiteOperacao && current < previous * 0.5) {
                            alerts.push({
                                type: 'warning',
                                timestamp: timestamp,
                                message: `Queda brusca de vaz√£o: ${previous.toFixed(1)} ‚Üí ${current.toFixed(1)} m¬≥/h`
                            });
                        }
                    }
                }

                // Remove duplicate alerts (same type and message within 5 minutes)
                alerts = alerts.filter((alert, index, self) => {
                    return index === self.findIndex(a => 
                        a.type === alert.type && 
                        a.message === alert.message &&
                        Math.abs(new Date(a.timestamp) - new Date(alert.timestamp)) < 5 * 60 * 1000
                    );
                });

                reportData.dispositivos.push({
                    info: device,
                    leituras: leituras,
                    configuracao: {
                        vazaoNominal: vazaoNominal,
                        limiteOperacao: limiteOperacao,
                        alertaMinimo: alertaMinimo,
                        alertaMaximo: alertaMaximo,
                        intervaloMinutos: intervaloMinutos,
                        configurado: device.vazao_nominal !== null
                    },
                    estatisticas: {
                        media: media,
                        max: max,
                        min: min,
                        totalVolume: totalVolume,
                        operationHours: operationMinutes / 60,
                        totalLeituras: leituras.length
                    },
                    alerts: alerts
                });
            }

            return reportData;
        }

        function renderReportPreview(data) {
            const container = document.getElementById('reportContent');
            
            let alertsHTML = '';
            let allAlerts = [];
            data.dispositivos.forEach(d => {
                allAlerts = allAlerts.concat(d.alerts.map(a => ({...a, device: d.info.nome})));
            });

            if (allAlerts.length > 0) {
                alertsHTML = `
                    <div class="report-alerts">
                        <h3>‚ö†Ô∏è Alertas Detectados (${allAlerts.length})</h3>
                        ${allAlerts.slice(0, 10).map(a => `
                            <div class="alert-item ${a.type}">
                                <span class="icon">${a.type === 'critical' ? 'üî¥' : 'üü°'}</span>
                                <div>
                                    <strong>${a.device}</strong> - ${new Date(a.timestamp).toLocaleString('pt-BR')}<br>
                                    ${a.message}
                                </div>
                            </div>
                        `).join('')}
                        ${allAlerts.length > 10 ? `<p style="font-size: 12px; color: #666; margin-top: 8px;">E mais ${allAlerts.length - 10} alertas...</p>` : ''}
                    </div>
                `;
            } else {
                alertsHTML = `
                    <div class="report-alerts">
                        <h3>‚úÖ Status</h3>
                        <div class="no-alerts">Nenhum alerta ou anomalia detectada no per√≠odo.</div>
                    </div>
                `;
            }

            container.innerHTML = `
                <div class="report-header">
                    <div class="report-logo">
                        <img src="${LOGO_BASE64}" alt="Electrogrupo">
                    </div>
                    <div class="report-info">
                        <h1>Relat√≥rio de Monitoramento</h1>
                        <p>${formatDateRange(data.periodo.inicio, data.periodo.fim)}</p>
                        <p>Gerado em: ${data.geradoEm.toLocaleString('pt-BR')}</p>
                    </div>
                </div>

                <div class="report-client-info">
                    <h3>Informa√ß√µes do Cliente</h3>
                    <p><strong>Fazenda:</strong> ${data.fazenda.nome}</p>
                    <p><strong>Endere√ßo:</strong> ${data.fazenda.endereco || 'N√£o informado'}</p>
                    <p><strong>Dispositivos:</strong> ${data.dispositivos.length}</p>
                </div>

                ${data.dispositivos.map(d => `
                    <div style="margin-bottom: 40px; page-break-inside: avoid;">
                        <h2 style="font-size: 18px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #2563eb;">
                            üìç ${d.info.nome}
                        </h2>
                        
                        <div style="background: ${d.configuracao.configurado ? '#e8f5e9' : '#fff3e0'}; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 13px;">
                            <strong>${d.configuracao.configurado ? '‚úÖ Dispositivo Configurado' : '‚ö†Ô∏è Usando valores calculados'}</strong><br>
                            Vaz√£o Nominal: ${d.configuracao.vazaoNominal.toFixed(1)} m¬≥/h | 
                            Limite Opera√ß√£o (50%): ${d.configuracao.limiteOperacao.toFixed(1)} m¬≥/h |
                            Intervalo: ${d.configuracao.intervaloMinutos} min
                            ${d.configuracao.alertaMinimo ? ` | Alerta M√≠n: ${d.configuracao.alertaMinimo} m¬≥/h` : ''}
                            ${d.configuracao.alertaMaximo ? ` | Alerta M√°x: ${d.configuracao.alertaMaximo} m¬≥/h` : ''}
                        </div>
                        
                        ${reportConfig.includeSummary ? `
                        <div class="report-summary">
                            <div class="report-stat">
                                <div class="value">${d.estatisticas.media.toFixed(2)}</div>
                                <div class="label">M√©dia (m¬≥/h)</div>
                            </div>
                            <div class="report-stat">
                                <div class="value">${d.estatisticas.max.toFixed(2)}</div>
                                <div class="label">M√°ximo (m¬≥/h)</div>
                            </div>
                            <div class="report-stat">
                                <div class="value">${d.estatisticas.min.toFixed(2)}</div>
                                <div class="label">M√≠nimo (m¬≥/h)</div>
                            </div>
                            <div class="report-stat">
                                <div class="value">${d.estatisticas.totalVolume.toFixed(1)}</div>
                                <div class="label">Total (m¬≥)</div>
                            </div>
                        </div>
                        ` : ''}

                        ${reportConfig.includeOperation ? `
                        <div class="report-summary" style="grid-template-columns: repeat(2, 1fr);">
                            <div class="report-stat">
                                <div class="value">${d.estatisticas.operationHours.toFixed(1)}h</div>
                                <div class="label">Tempo de Opera√ß√£o</div>
                            </div>
                            <div class="report-stat">
                                <div class="value">${d.estatisticas.totalLeituras}</div>
                                <div class="label">Total de Leituras</div>
                            </div>
                        </div>
                        ` : ''}

                        ${reportConfig.includeChart ? `
                        <div class="report-chart-container">
                            <h3>üìà Evolu√ß√£o da Vaz√£o</h3>
                            <div class="report-chart">
                                <canvas id="reportChart-${d.info.id}"></canvas>
                            </div>
                        </div>
                        ` : ''}

                        ${reportConfig.includeTable ? `
                        <div class="report-table-container">
                            <h3>üìã Leituras do Per√≠odo</h3>
                            <table class="report-table">
                                <thead>
                                    <tr>
                                        <th>Data/Hora</th>
                                        <th>Vaz√£o (m¬≥/h)</th>
                                        <th>Vaz√£o (L/s)</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${d.leituras.slice(-20).reverse().map(l => {
                                        const valor = parseFloat(l.valor);
                                        const operando = valor >= d.configuracao.limiteOperacao;
                                        return `
                                            <tr>
                                                <td>${new Date(l.timestamp).toLocaleString('pt-BR')}</td>
                                                <td>${valor.toFixed(2)}</td>
                                                <td>${(valor / 3.6).toFixed(2)}</td>
                                                <td style="color: ${operando ? '#22c55e' : '#f59e0b'}">${operando ? 'üü¢ Operando' : 'üü° Parado'}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                            ${d.leituras.length > 20 ? `<p style="font-size: 12px; color: #666; margin-top: 8px;">Mostrando √∫ltimas 20 de ${d.leituras.length} leituras</p>` : ''}
                        </div>
                        ` : ''}
                    </div>
                `).join('')}

                ${reportConfig.includeAlerts ? alertsHTML : ''}

                <div class="report-footer">
                    <p>Relat√≥rio gerado automaticamente pelo sistema DataView - Electrogrupo S.A.C.I.</p>
                    <p>¬© ${new Date().getFullYear()} Electrogrupo - Todos os direitos reservados</p>
                </div>
            `;

            // Render charts
            if (reportConfig.includeChart) {
                setTimeout(() => {
                    data.dispositivos.forEach(d => {
                        renderReportChart(d.info.id, d.leituras, d.configuracao);
                    });
                }, 100);
            }

            document.getElementById('reportPreview').classList.add('active');
        }

        function renderReportChart(deviceId, leituras, config) {
            const canvas = document.getElementById(`reportChart-${deviceId}`);
            if (!canvas || leituras.length === 0) return;

            const ctx = canvas.getContext('2d');
            canvas.width = canvas.parentElement.clientWidth - 32;
            canvas.height = 200;

            const valores = leituras.map(l => parseFloat(l.valor));
            const min = Math.min(...valores, config ? config.limiteOperacao : 0) * 0.9;
            const max = Math.max(...valores, config ? config.vazaoNominal : valores[0]) * 1.1;
            const range = max - min || 1;

            // Draw grid
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = (canvas.height / 4) * i;
                ctx.beginPath();
                ctx.moveTo(50, y);
                ctx.lineTo(canvas.width - 10, y);
                ctx.stroke();
            }

            // Draw operation limit line (50% of nominal)
            if (config && config.limiteOperacao) {
                const limitY = canvas.height - 20 - ((config.limiteOperacao - min) / range) * (canvas.height - 40);
                ctx.beginPath();
                ctx.strokeStyle = '#f59e0b';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.moveTo(50, limitY);
                ctx.lineTo(canvas.width - 10, limitY);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Label
                ctx.fillStyle = '#f59e0b';
                ctx.font = '10px Arial';
                ctx.fillText(`Limite Op. (${config.limiteOperacao.toFixed(1)})`, canvas.width - 100, limitY - 5);
            }

            // Draw nominal line
            if (config && config.vazaoNominal) {
                const nominalY = canvas.height - 20 - ((config.vazaoNominal - min) / range) * (canvas.height - 40);
                ctx.beginPath();
                ctx.strokeStyle = '#22c55e';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.moveTo(50, nominalY);
                ctx.lineTo(canvas.width - 10, nominalY);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Label
                ctx.fillStyle = '#22c55e';
                ctx.font = '10px Arial';
                ctx.fillText(`Nominal (${config.vazaoNominal.toFixed(1)})`, canvas.width - 90, nominalY - 5);
            }

            // Draw data line
            ctx.beginPath();
            ctx.strokeStyle = '#2563eb';
            ctx.lineWidth = 2;

            valores.forEach((val, i) => {
                const x = 50 + (i / (valores.length - 1)) * (canvas.width - 60);
                const y = canvas.height - 20 - ((val - min) / range) * (canvas.height - 40);
                
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });

            ctx.stroke();

            // Fill area
            ctx.lineTo(canvas.width - 10, canvas.height - 20);
            ctx.lineTo(50, canvas.height - 20);
            ctx.closePath();
            
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, 'rgba(37, 99, 235, 0.3)');
            gradient.addColorStop(1, 'rgba(37, 99, 235, 0)');
            ctx.fillStyle = gradient;
            ctx.fill();

            // Y axis labels
            ctx.fillStyle = '#666';
            ctx.font = '11px Arial';
            ctx.textAlign = 'right';
            for (let i = 0; i <= 4; i++) {
                const val = max - (range * i / 4);
                const y = (canvas.height / 4) * i + 4;
                ctx.fillText(val.toFixed(1), 45, y);
            }
        }

        function formatDateRange(start, end) {
            const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
            return `${start.toLocaleDateString('pt-BR', options)} a ${end.toLocaleDateString('pt-BR', options)}`;
        }

        function closeReportPreview() {
            document.getElementById('reportPreview').classList.remove('active');
        }

        async function generatePDF(data) {
            // Para PDF, mostrar preview primeiro e deixar usu√°rio baixar
            renderReportPreview(data);
            showToast('Relat√≥rio pronto! Use os bot√µes para baixar.', 'success');
        }

        function downloadReportPDF() {
            const content = document.getElementById('reportContent').innerHTML;
            
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                showToast('Bloqueador de pop-up ativo. Permita pop-ups para baixar o PDF.', 'error');
                return;
            }
            
            printWindow.document.write(
                '<!DOCTYPE html>' +
                '<html>' +
                '<head>' +
                '<title>Relat√≥rio Electrogrupo</title>' +
                '<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">' +
                '<style>' +
                'body { font-family: Plus Jakarta Sans, Arial, sans-serif; padding: 20px; color: #1a1a1a; }' +
                '.report-container { max-width: 100%; }' +
                '.report-header { display: flex; justify-content: space-between; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #e0e0e0; }' +
                '.report-logo img { height: 50px; }' +
                '.report-info { text-align: right; }' +
                '.report-info h1 { font-size: 24px; margin-bottom: 4px; }' +
                '.report-info p { font-size: 12px; color: #666; margin: 2px 0; }' +
                '.report-client-info { background: #f5f5f5; padding: 16px; border-radius: 8px; margin-bottom: 24px; }' +
                '.report-client-info h3 { font-size: 14px; color: #666; margin-bottom: 8px; }' +
                '.report-client-info p { font-size: 14px; margin: 4px 0; }' +
                '.report-summary { display: flex; gap: 16px; margin-bottom: 30px; }' +
                '.report-stat { flex: 1; background: #f0f7ff; padding: 16px; border-radius: 8px; text-align: center; }' +
                '.report-stat .value { font-size: 28px; font-weight: 700; color: #2563eb; }' +
                '.report-stat .label { font-size: 11px; color: #666; text-transform: uppercase; margin-top: 4px; }' +
                '.report-table { width: 100%; border-collapse: collapse; }' +
                '.report-table th { background: #f0f0f0; padding: 10px; text-align: left; font-size: 12px; }' +
                '.report-table td { padding: 10px; font-size: 13px; border-bottom: 1px solid #eee; }' +
                '.report-footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #e0e0e0; font-size: 11px; color: #999; text-align: center; }' +
                '.alert-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; margin-bottom: 8px; }' +
                '.alert-item.critical { background: #f8d7da; border-left-color: #dc3545; }' +
                '.no-alerts { padding: 16px; background: #d4edda; border-radius: 8px; color: #155724; text-align: center; }' +
                '@media print { body { padding: 0; } .report-container { box-shadow: none; } }' +
                '</style>' +
                '</head>' +
                '<body>' +
                '<div class="report-container">' + content + '</div>' +
                '<scr' + 'ipt>window.onload = function() { setTimeout(function() { window.print(); }, 500); };</scr' + 'ipt>' +
                '</body>' +
                '</html>'
            );
            printWindow.document.close();
        }

        function generateExcel(data) {
            let csvContent = 'Data/Hora,Dispositivo,Vaz√£o (m¬≥/h),Vaz√£o (L/s)\n';
            
            data.dispositivos.forEach(d => {
                d.leituras.forEach(l => {
                    const valor = parseFloat(l.valor);
                    csvContent += `${new Date(l.timestamp).toLocaleString('pt-BR')},${d.info.nome},${valor.toFixed(2)},${(valor/3.6).toFixed(2)}\n`;
                });
            });

            // Add summary sheet
            csvContent += '\n\nRESUMO\n';
            csvContent += 'Dispositivo,M√©dia (m¬≥/h),M√°ximo,M√≠nimo,Total (m¬≥),Tempo Opera√ß√£o (h)\n';
            data.dispositivos.forEach(d => {
                csvContent += `${d.info.nome},${d.estatisticas.media.toFixed(2)},${d.estatisticas.max.toFixed(2)},${d.estatisticas.min.toFixed(2)},${d.estatisticas.totalVolume.toFixed(1)},${d.estatisticas.operationHours.toFixed(1)}\n`;
            });

            downloadFile(csvContent, `relatorio_${data.fazenda.nome}_${Date.now()}.csv`, 'text/csv');
            showToast('Arquivo Excel/CSV gerado!', 'success');
        }

        async function downloadReportExcel() {
            // Get current report data and export
            const config = { ...reportConfig };
            config.device = document.getElementById('reportDevice')?.value || 'all';
            
            const today = new Date();
            let startDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            let endDate = today;
            
            if (config.period === 'custom') {
                const startInput = document.getElementById('reportDateStart')?.value;
                const endInput = document.getElementById('reportDateEnd')?.value;
                if (startInput) startDate = new Date(startInput);
                if (endInput) endDate = new Date(endInput);
            }
            
            config.dateStart = startDate;
            config.dateEnd = endDate;
            
            const data = await getReportData(config);
            generateExcel(data);
        }

        function generateCSV(data) {
            generateExcel(data); // Same format
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
