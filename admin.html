<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electrogrupo DataView - Administra√ß√£o</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f; --bg-secondary: #12121a; --bg-card: #1a1a24; --bg-hover: #22222e;
            --border-color: #2a2a3a; --text-primary: #f0f0f5; --text-secondary: #a0a0b0; --text-muted: #606070;
            --accent-blue: #3b82f6; --accent-green: #22c55e; --accent-red: #ef4444; --accent-yellow: #f59e0b; --accent-purple: #8b5cf6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
        
        .header { background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .logo { font-size: 20px; font-weight: 700; color: var(--accent-blue); }
        .header-title { font-size: 14px; color: var(--text-secondary); padding-left: 16px; border-left: 1px solid var(--border-color); }
        
        .btn { padding: 10px 16px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; border: none; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--accent-blue); color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-secondary { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background: var(--bg-hover); }
        .btn-ghost { background: transparent; color: var(--text-secondary); }
        .btn-ghost:hover { background: var(--bg-hover); color: var(--text-primary); }
        .btn-danger { background: var(--accent-red); color: white; }
        
        .layout { display: flex; min-height: calc(100vh - 65px); }
        .sidebar { width: 240px; background: var(--bg-secondary); border-right: 1px solid var(--border-color); padding: 20px 0; }
        .sidebar-title { font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; padding: 0 20px; margin: 16px 0 8px; }
        .sidebar-nav { list-style: none; }
        .sidebar-nav a { display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: var(--text-secondary); text-decoration: none; font-size: 14px; border-left: 3px solid transparent; }
        .sidebar-nav a:hover { background: var(--bg-hover); color: var(--text-primary); }
        .sidebar-nav a.active { background: rgba(59,130,246,0.1); color: var(--accent-blue); border-left-color: var(--accent-blue); }
        
        .main-content { flex: 1; padding: 24px; overflow-y: auto; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .page-title { font-size: 24px; font-weight: 600; }
        .page-subtitle { font-size: 14px; color: var(--text-secondary); margin-top: 4px; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; }
        .stat-card .icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-bottom: 12px; }
        .stat-card .icon.blue { background: rgba(59,130,246,0.2); }
        .stat-card .icon.green { background: rgba(34,197,94,0.2); }
        .stat-card .icon.yellow { background: rgba(245,158,11,0.2); }
        .stat-card .icon.purple { background: rgba(139,92,246,0.2); }
        .stat-card .value { font-size: 28px; font-weight: 700; }
        .stat-card .label { font-size: 13px; color: var(--text-secondary); margin-top: 4px; }
        
        .table-container { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px 20px; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); }
        td { padding: 16px 20px; font-size: 14px; border-bottom: 1px solid var(--border-color); }
        tr:hover { background: var(--bg-hover); }
        
        .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }
        .status-badge.active { background: rgba(34,197,94,0.2); color: var(--accent-green); }
        .status-badge.inactive { background: rgba(239,68,68,0.2); color: var(--accent-red); }
        
        .role-badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .role-badge.superadmin { background: rgba(139,92,246,0.2); color: var(--accent-purple); }
        .role-badge.admin { background: rgba(59,130,246,0.2); color: var(--accent-blue); }
        .role-badge.manager { background: rgba(34,197,94,0.2); color: var(--accent-green); }
        .role-badge.operator { background: rgba(245,158,11,0.2); color: var(--accent-yellow); }
        .role-badge.viewer { background: rgba(160,160,176,0.2); color: var(--text-secondary); }
        
        .btn-icon { width: 32px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center; background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-secondary); cursor: pointer; }
        .btn-icon:hover { border-color: var(--accent-blue); color: var(--accent-blue); }
        .btn-icon.danger:hover { border-color: var(--accent-red); color: var(--accent-red); }
        .action-buttons { display: flex; gap: 8px; }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 16px; width: 100%; max-width: 600px; max-height: 90vh; overflow: hidden; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border-color); }
        .modal-title { font-size: 18px; font-weight: 600; }
        .modal-close { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); cursor: pointer; font-size: 18px; }
        .modal-body { padding: 24px; overflow-y: auto; max-height: 60vh; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 12px; padding: 16px 24px; border-top: 1px solid var(--border-color); }
        
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 13px; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px; }
        .form-label .required { color: var(--accent-red); }
        .form-input { width: 100%; padding: 12px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px; }
        .form-input:focus { outline: none; border-color: var(--accent-blue); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .form-hint { font-size: 12px; color: var(--text-muted); margin-top: 6px; }
        
        .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
        .login-box { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 16px; padding: 40px; width: 100%; max-width: 400px; }
        .login-logo { text-align: center; margin-bottom: 32px; }
        .login-logo h1 { font-size: 24px; color: var(--accent-blue); }
        .login-logo p { font-size: 14px; color: var(--text-secondary); margin-top: 8px; }
        
        .access-denied { text-align: center; padding: 60px 20px; }
        .access-denied .icon { font-size: 64px; margin-bottom: 20px; }
        .access-denied h2 { margin-bottom: 12px; }
        .access-denied p { color: var(--text-secondary); margin-bottom: 24px; }
        
        .tree-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px; margin-left: 24px; }
        .tree-item:first-child { margin-left: 0; }
        .tree-item .info { flex: 1; }
        .tree-item .name { font-weight: 500; }
        .tree-item .meta { font-size: 12px; color: var(--text-secondary); }
        
        .empty-state { text-align: center; padding: 60px 20px; }
        .empty-state .icon { font-size: 48px; margin-bottom: 16px; }
        .empty-state .title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .empty-state .description { font-size: 14px; color: var(--text-secondary); margin-bottom: 20px; }
        
        .toast { position: fixed; bottom: 24px; right: 24px; padding: 16px 20px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 10px; display: flex; align-items: center; gap: 12px; transform: translateY(100px); opacity: 0; transition: all 0.3s; z-index: 2000; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { border-color: var(--accent-green); }
        .toast.error { border-color: var(--accent-red); }
        
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(10,10,15,0.9); z-index: 3000; align-items: center; justify-content: center; }
        .loading-overlay.active { display: flex; }
        .spinner { width: 48px; height: 48px; border: 3px solid var(--border-color); border-top-color: var(--accent-blue); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        @media (max-width: 1024px) { .sidebar { display: none; } .form-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div></div>
    <div class="toast" id="toast"><span class="toast-icon">‚úì</span><span class="toast-message"></span></div>

    <!-- Login -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <div class="login-logo"><h1>‚ö° Electrogrupo</h1><p>Painel de Administra√ß√£o</p></div>
            <form id="loginForm">
                <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="loginEmail" required></div>
                <div class="form-group"><label class="form-label">Senha</label><input type="password" class="form-input" id="loginPassword" required></div>
                <button type="submit" class="btn btn-primary" style="width:100%" id="loginBtn">Entrar</button>
                <p id="loginError" style="color:var(--accent-red);font-size:13px;margin-top:12px;display:none"></p>
            </form>
        </div>
    </div>

    <!-- Access Denied -->
    <div class="access-denied" id="accessDenied" style="display:none">
        <div class="icon">üîí</div><h2>Acesso Negado</h2><p>Voc√™ n√£o tem permiss√£o para acessar o painel de administra√ß√£o.</p>
        <button class="btn btn-secondary" onclick="location.href='index.html'">Voltar ao Dashboard</button>
        <button class="btn btn-ghost" onclick="logout()">Sair</button>
    </div>

    <!-- Main App -->
    <div id="mainApp" style="display:none">
        <header class="header">
            <div class="header-left"><div class="logo">‚ö° Electrogrupo</div><div class="header-title">Painel de Administra√ß√£o</div></div>
            <div class="header-right">
                <button class="btn btn-secondary" onclick="location.href='index.html'">üìä Dashboard</button>
                <button class="btn btn-ghost" onclick="logout()">Sair</button>
            </div>
        </header>
        <div class="layout">
            <aside class="sidebar">
                <div class="sidebar-title">Geral</div>
                <ul class="sidebar-nav"><li><a href="#" class="active" data-page="overview">üìä Vis√£o Geral</a></li></ul>
                <div class="sidebar-title">Gest√£o</div>
                <ul class="sidebar-nav">
                    <li><a href="#" data-page="empresas">üè¢ Empresas</a></li>
                    <li><a href="#" data-page="fazendas">üåæ Fazendas</a></li>
                    <li><a href="#" data-page="dispositivos">üì° Dispositivos</a></li>
                    <li><a href="#" data-page="usuarios">üë• Usu√°rios</a></li>
                </ul>
                <div class="sidebar-title">Sistema</div>
                <ul class="sidebar-nav"><li><a href="#" data-page="logs">üìã Logs</a></li></ul>
            </aside>
            <main class="main-content" id="mainContent"></main>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="modalEmpresa">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title" id="modalEmpresaTitle">Nova Empresa</h3><button class="modal-close" onclick="closeModal('modalEmpresa')">√ó</button></div>
            <div class="modal-body">
                <form id="formEmpresa">
                    <input type="hidden" id="empresaId">
                    <div class="form-group"><label class="form-label">Nome <span class="required">*</span></label><input type="text" class="form-input" id="empresaNome" required></div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">CNPJ</label><input type="text" class="form-input" id="empresaCnpj"></div>
                        <div class="form-group"><label class="form-label">Telefone</label><input type="text" class="form-input" id="empresaTelefone"></div>
                    </div>
                    <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="empresaEmail"></div>
                    <div class="form-group"><label class="form-label">Endere√ßo</label><textarea class="form-input" id="empresaEndereco" rows="2"></textarea></div>
                </form>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modalEmpresa')">Cancelar</button><button class="btn btn-primary" onclick="saveEmpresa()">Salvar</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="modalFazenda">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title" id="modalFazendaTitle">Nova Fazenda</h3><button class="modal-close" onclick="closeModal('modalFazenda')">√ó</button></div>
            <div class="modal-body">
                <form id="formFazenda">
                    <input type="hidden" id="fazendaId">
                    <div class="form-group"><label class="form-label">Empresa <span class="required">*</span></label><select class="form-input" id="fazendaEmpresa" required></select></div>
                    <div class="form-group"><label class="form-label">Nome <span class="required">*</span></label><input type="text" class="form-input" id="fazendaNome" required></div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Respons√°vel</label><input type="text" class="form-input" id="fazendaResponsavel"></div>
                        <div class="form-group"><label class="form-label">Telefone</label><input type="text" class="form-input" id="fazendaTelefone"></div>
                    </div>
                    <div class="form-group"><label class="form-label">√Årea (hectares)</label><input type="number" class="form-input" id="fazendaArea" step="0.01"></div>
                    <div class="form-group"><label class="form-label">Endere√ßo</label><textarea class="form-input" id="fazendaEndereco" rows="2"></textarea></div>
                </form>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modalFazenda')">Cancelar</button><button class="btn btn-primary" onclick="saveFazenda()">Salvar</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="modalDispositivo">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title" id="modalDispositivoTitle">Novo Dispositivo</h3><button class="modal-close" onclick="closeModal('modalDispositivo')">√ó</button></div>
            <div class="modal-body">
                <form id="formDispositivo">
                    <input type="hidden" id="dispositivoId">
                    <div class="form-group"><label class="form-label">Fazenda <span class="required">*</span></label><select class="form-input" id="dispositivoFazenda" required></select></div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Nome <span class="required">*</span></label><input type="text" class="form-input" id="dispositivoNome" required></div>
                        <div class="form-group"><label class="form-label">Modelo</label><input type="text" class="form-input" id="dispositivoModelo"></div>
                    </div>
                    <div class="form-group"><label class="form-label">Token API <span class="required">*</span></label><input type="text" class="form-input" id="dispositivoToken" required><div class="form-hint">Token de 32 caracteres da API ISSO Digital</div></div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Latitude</label><input type="number" class="form-input" id="dispositivoLat" step="any"></div>
                        <div class="form-group"><label class="form-label">Longitude</label><input type="number" class="form-input" id="dispositivoLng" step="any"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Vaz√£o Nominal (m¬≥/h)</label><input type="number" class="form-input" id="dispositivoVazao" step="0.01"></div>
                        <div class="form-group"><label class="form-label">Unidade</label><select class="form-input" id="dispositivoUnidade"><option value="m3h">m¬≥/h</option><option value="ls">L/s</option></select></div>
                    </div>
                    <div class="form-group"><label class="form-label">Descri√ß√£o</label><textarea class="form-input" id="dispositivoDesc" rows="2"></textarea></div>
                </form>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modalDispositivo')">Cancelar</button><button class="btn btn-primary" onclick="saveDispositivo()">Salvar</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="modalUsuario">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title" id="modalUsuarioTitle">Novo Usu√°rio</h3><button class="modal-close" onclick="closeModal('modalUsuario')">√ó</button></div>
            <div class="modal-body">
                <form id="formUsuario">
                    <input type="hidden" id="usuarioId">
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Nome <span class="required">*</span></label><input type="text" class="form-input" id="usuarioNome" required></div>
                        <div class="form-group"><label class="form-label">Cargo</label><input type="text" class="form-input" id="usuarioCargo"></div>
                    </div>
                    <div class="form-group"><label class="form-label">Email <span class="required">*</span></label><input type="email" class="form-input" id="usuarioEmail" required></div>
                    <div class="form-group" id="senhaGroup"><label class="form-label">Senha <span class="required">*</span></label><input type="password" class="form-input" id="usuarioSenha" minlength="6"><div class="form-hint">M√≠nimo 6 caracteres</div></div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Empresa <span class="required">*</span></label><select class="form-input" id="usuarioEmpresa" required></select></div>
                        <div class="form-group"><label class="form-label">Fun√ß√£o <span class="required">*</span></label><select class="form-input" id="usuarioRole" required></select></div>
                    </div>
                    <div class="form-group"><label class="form-label">Fazenda</label><select class="form-input" id="usuarioFazenda"></select><div class="form-hint">Deixe vazio para acesso a todas as fazendas</div></div>
                </form>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modalUsuario')">Cancelar</button><button class="btn btn-primary" onclick="saveUsuario()">Salvar</button></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://ddrbyexthwzkmmeigpql.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkcmJ5ZXh0aHd6a21tZWlncHFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4OTMxNTgsImV4cCI6MjA4MTQ2OTE1OH0.vMtwNQ3a4--wWMNz734u4KB6sdYQbZ727HRovNZHHAE';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null, currentPerfil = null;
        let empresas = [], fazendas = [], dispositivos = [], usuarios = [], roles = [];

        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            setupNav();
        });

        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) { currentUser = session.user; await loadProfile(); }
            else showLogin();
            supabaseClient.auth.onAuthStateChange(async (e, s) => {
                if (e === 'SIGNED_IN' && s) { currentUser = s.user; await loadProfile(); }
                else if (e === 'SIGNED_OUT') showLogin();
            });
        }

        async function loadProfile() {
            try {
                const { data: perfil } = await supabaseClient.from('perfis').select('*, roles(*)').eq('id', currentUser.id).single();
                currentPerfil = perfil;
                if ((perfil?.roles?.nivel || 0) >= 3 || perfil?.is_admin) { showApp(); await loadData(); render('overview'); }
                else showAccessDenied();
            } catch (e) { console.error(e); showToast('Erro ao carregar perfil', 'error'); }
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('loginBtn');
            btn.disabled = true; btn.textContent = 'Entrando...';
            try {
                const { error } = await supabaseClient.auth.signInWithPassword({
                    email: document.getElementById('loginEmail').value,
                    password: document.getElementById('loginPassword').value
                });
                if (error) throw error;
            } catch (e) {
                document.getElementById('loginError').textContent = 'Email ou senha incorretos';
                document.getElementById('loginError').style.display = 'block';
            }
            btn.disabled = false; btn.textContent = 'Entrar';
        });

        async function logout() { await supabaseClient.auth.signOut(); location.reload(); }
        function showLogin() { document.getElementById('loginContainer').style.display = 'flex'; document.getElementById('mainApp').style.display = 'none'; document.getElementById('accessDenied').style.display = 'none'; }
        function showApp() { document.getElementById('loginContainer').style.display = 'none'; document.getElementById('mainApp').style.display = 'block'; document.getElementById('accessDenied').style.display = 'none'; }
        function showAccessDenied() { document.getElementById('loginContainer').style.display = 'none'; document.getElementById('mainApp').style.display = 'none'; document.getElementById('accessDenied').style.display = 'block'; }
        function showLoading() { document.getElementById('loadingOverlay').classList.add('active'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.remove('active'); }
        function showToast(msg, type = 'success') { const t = document.getElementById('toast'); t.querySelector('.toast-message').textContent = msg; t.querySelector('.toast-icon').textContent = type === 'success' ? '‚úì' : '‚úï'; t.className = `toast ${type} show`; setTimeout(() => t.classList.remove('show'), 3000); }
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function setupNav() {
            document.querySelectorAll('.sidebar-nav a').forEach(a => {
                a.addEventListener('click', e => {
                    e.preventDefault();
                    document.querySelectorAll('.sidebar-nav a').forEach(l => l.classList.remove('active'));
                    a.classList.add('active');
                    render(a.dataset.page);
                });
            });
        }

        async function loadData() {
            showLoading();
            try {
                const [r1, r2, r3, r4, r5] = await Promise.all([
                    supabaseClient.from('roles').select('*').order('nivel', { ascending: false }),
                    supabaseClient.from('empresas').select('*').order('nome'),
                    supabaseClient.from('fazendas').select('*, empresas(nome)').order('nome'),
                    supabaseClient.from('dispositivos').select('*, fazendas(nome, empresas(nome))').order('nome'),
                    supabaseClient.from('perfis').select('*, roles(nome, nivel), empresas(nome), fazendas(nome)').order('nome')
                ]);
                roles = r1.data || []; empresas = r2.data || []; fazendas = r3.data || []; dispositivos = r4.data || []; usuarios = r5.data || [];
            } catch (e) { console.error(e); showToast('Erro ao carregar dados', 'error'); }
            hideLoading();
        }

        function render(page) {
            const c = document.getElementById('mainContent');
            if (page === 'overview') c.innerHTML = renderOverview();
            else if (page === 'empresas') c.innerHTML = renderEmpresas();
            else if (page === 'fazendas') c.innerHTML = renderFazendas();
            else if (page === 'dispositivos') c.innerHTML = renderDispositivos();
            else if (page === 'usuarios') c.innerHTML = renderUsuarios();
            else if (page === 'logs') { c.innerHTML = renderLogs(); loadLogs(); }
        }

        function renderOverview() {
            return `<div class="page-header"><div><h1 class="page-title">Vis√£o Geral</h1><p class="page-subtitle">Resumo do sistema</p></div></div>
            <div class="stats-grid">
                <div class="stat-card"><div class="icon blue">üè¢</div><div class="value">${empresas.length}</div><div class="label">Empresas</div></div>
                <div class="stat-card"><div class="icon green">üåæ</div><div class="value">${fazendas.length}</div><div class="label">Fazendas</div></div>
                <div class="stat-card"><div class="icon yellow">üì°</div><div class="value">${dispositivos.filter(d=>d.ativo).length}</div><div class="label">Dispositivos Ativos</div></div>
                <div class="stat-card"><div class="icon purple">üë•</div><div class="value">${usuarios.length}</div><div class="label">Usu√°rios</div></div>
            </div>
            <div class="table-container" style="padding:20px"><h3 style="margin-bottom:20px">üìä Hierarquia</h3>
            ${empresas.map(e => `<div class="tree-item" style="margin-left:0;background:var(--bg-card)"><span>üè¢</span><div class="info"><div class="name">${e.nome}</div><div class="meta">${fazendas.filter(f=>f.empresa_id===e.id).length} fazendas</div></div></div>
            ${fazendas.filter(f=>f.empresa_id===e.id).map(f => `<div class="tree-item"><span>üåæ</span><div class="info"><div class="name">${f.nome}</div><div class="meta">${dispositivos.filter(d=>d.fazenda_id===f.id).length} dispositivos</div></div></div>
            ${dispositivos.filter(d=>d.fazenda_id===f.id).map(d => `<div class="tree-item" style="margin-left:48px"><span>üì°</span><div class="info"><div class="name">${d.nome}</div><div class="meta">${d.ativo?'üü¢ Ativo':'üî¥ Inativo'}</div></div></div>`).join('')}`).join('')}`).join('')}</div>`;
        }

        function renderEmpresas() {
            return `<div class="page-header"><div><h1 class="page-title">Empresas</h1></div><button class="btn btn-primary" onclick="openEmpresaModal()">+ Nova Empresa</button></div>
            <div class="table-container"><table><thead><tr><th>Nome</th><th>CNPJ</th><th>Telefone</th><th>Fazendas</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody>
            ${empresas.map(e => `<tr><td><strong>${e.nome}</strong></td><td>${e.cnpj||'-'}</td><td>${e.telefone||'-'}</td><td>${fazendas.filter(f=>f.empresa_id===e.id).length}</td>
            <td><span class="status-badge ${e.ativo!==false?'active':'inactive'}">${e.ativo!==false?'‚óè Ativo':'‚óè Inativo'}</span></td>
            <td><div class="action-buttons"><button class="btn-icon" onclick="editEmpresa('${e.id}')">‚úèÔ∏è</button><button class="btn-icon danger" onclick="deleteEmpresa('${e.id}')">üóëÔ∏è</button></div></td></tr>`).join('')}
            </tbody></table>${empresas.length===0?'<div class="empty-state"><div class="icon">üè¢</div><div class="title">Nenhuma empresa</div><button class="btn btn-primary" onclick="openEmpresaModal()">+ Nova</button></div>':''}</div>`;
        }

        function renderFazendas() {
            return `<div class="page-header"><div><h1 class="page-title">Fazendas</h1></div><button class="btn btn-primary" onclick="openFazendaModal()">+ Nova Fazenda</button></div>
            <div class="table-container"><table><thead><tr><th>Nome</th><th>Empresa</th><th>Respons√°vel</th><th>Dispositivos</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody>
            ${fazendas.map(f => `<tr><td><strong>${f.nome}</strong></td><td>${f.empresas?.nome||'-'}</td><td>${f.responsavel||'-'}</td><td>${dispositivos.filter(d=>d.fazenda_id===f.id).length}</td>
            <td><span class="status-badge ${f.ativo!==false?'active':'inactive'}">${f.ativo!==false?'‚óè Ativo':'‚óè Inativo'}</span></td>
            <td><div class="action-buttons"><button class="btn-icon" onclick="editFazenda('${f.id}')">‚úèÔ∏è</button><button class="btn-icon danger" onclick="deleteFazenda('${f.id}')">üóëÔ∏è</button></div></td></tr>`).join('')}
            </tbody></table>${fazendas.length===0?'<div class="empty-state"><div class="icon">üåæ</div><div class="title">Nenhuma fazenda</div><button class="btn btn-primary" onclick="openFazendaModal()">+ Nova</button></div>':''}</div>`;
        }

        function renderDispositivos() {
            return `<div class="page-header"><div><h1 class="page-title">Dispositivos</h1></div><button class="btn btn-primary" onclick="openDispositivoModal()">+ Novo Dispositivo</button></div>
            <div class="table-container"><table><thead><tr><th>Nome</th><th>Fazenda</th><th>Token</th><th>Vaz√£o Nom.</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody>
            ${dispositivos.map(d => `<tr><td><strong>${d.nome}</strong></td><td>${d.fazendas?.nome||'-'}</td><td><code style="font-size:11px;background:var(--bg-secondary);padding:4px 8px;border-radius:4px">${(d.token_api||'').substring(0,12)}...</code></td><td>${d.vazao_nominal?d.vazao_nominal+' m¬≥/h':'-'}</td>
            <td><span class="status-badge ${d.ativo?'active':'inactive'}">${d.ativo?'‚óè Ativo':'‚óè Inativo'}</span></td>
            <td><div class="action-buttons"><button class="btn-icon" onclick="editDispositivo('${d.id}')">‚úèÔ∏è</button><button class="btn-icon danger" onclick="deleteDispositivo('${d.id}')">üóëÔ∏è</button></div></td></tr>`).join('')}
            </tbody></table>${dispositivos.length===0?'<div class="empty-state"><div class="icon">üì°</div><div class="title">Nenhum dispositivo</div><button class="btn btn-primary" onclick="openDispositivoModal()">+ Novo</button></div>':''}</div>`;
        }

        function renderUsuarios() {
            return `<div class="page-header"><div><h1 class="page-title">Usu√°rios</h1></div><button class="btn btn-primary" onclick="openUsuarioModal()">+ Novo Usu√°rio</button></div>
            <div class="table-container"><table><thead><tr><th>Nome</th><th>Email</th><th>Fun√ß√£o</th><th>Empresa</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody>
            ${usuarios.map(u => `<tr><td><strong>${u.nome||u.email}</strong></td><td>${u.email}</td><td><span class="role-badge ${u.roles?.nome||'viewer'}">${u.roles?.nome||'viewer'}</span></td><td>${u.empresas?.nome||'-'}</td>
            <td><span class="status-badge ${u.ativo!==false?'active':'inactive'}">${u.ativo!==false?'‚óè Ativo':'‚óè Inativo'}</span></td>
            <td><div class="action-buttons"><button class="btn-icon" onclick="editUsuario('${u.id}')">‚úèÔ∏è</button>${u.id!==currentUser.id?`<button class="btn-icon danger" onclick="deleteUsuario('${u.id}')">üóëÔ∏è</button>`:''}</div></td></tr>`).join('')}
            </tbody></table></div>`;
        }

        function renderLogs() {
            return `<div class="page-header"><div><h1 class="page-title">Logs de Auditoria</h1></div></div>
            <div class="table-container"><table><thead><tr><th>Data/Hora</th><th>Usu√°rio</th><th>A√ß√£o</th><th>Tabela</th><th>ID</th></tr></thead><tbody id="logsBody"><tr><td colspan="5" style="text-align:center;padding:40px">Carregando...</td></tr></tbody></table></div>`;
        }

        async function loadLogs() {
            try {
                const { data } = await supabaseClient.from('audit_logs').select('*, perfis(nome, email)').order('created_at', { ascending: false }).limit(100);
                document.getElementById('logsBody').innerHTML = (data||[]).map(l => `<tr><td>${new Date(l.created_at).toLocaleString('pt-BR')}</td><td>${l.perfis?.nome||l.perfis?.email||'Sistema'}</td><td><span class="status-badge ${l.acao==='DELETE'?'inactive':'active'}">${l.acao}</span></td><td>${l.tabela||'-'}</td><td><code style="font-size:11px">${(l.registro_id||'').substring(0,8)}</code></td></tr>`).join('') || '<tr><td colspan="5" style="text-align:center;padding:40px">Nenhum log</td></tr>';
            } catch (e) { console.error(e); }
        }

        // CRUD Empresas
        function openEmpresaModal(e = null) {
            document.getElementById('modalEmpresaTitle').textContent = e ? 'Editar Empresa' : 'Nova Empresa';
            document.getElementById('empresaId').value = e?.id || '';
            document.getElementById('empresaNome').value = e?.nome || '';
            document.getElementById('empresaCnpj').value = e?.cnpj || '';
            document.getElementById('empresaTelefone').value = e?.telefone || '';
            document.getElementById('empresaEmail').value = e?.email || '';
            document.getElementById('empresaEndereco').value = e?.endereco || '';
            openModal('modalEmpresa');
        }
        function editEmpresa(id) { openEmpresaModal(empresas.find(e => e.id === id)); }
        async function saveEmpresa() {
            const id = document.getElementById('empresaId').value;
            const data = { nome: document.getElementById('empresaNome').value, cnpj: document.getElementById('empresaCnpj').value || null, telefone: document.getElementById('empresaTelefone').value || null, email: document.getElementById('empresaEmail').value || null, endereco: document.getElementById('empresaEndereco').value || null };
            try {
                if (id) await supabaseClient.from('empresas').update(data).eq('id', id);
                else await supabaseClient.from('empresas').insert(data);
                showToast(id ? 'Empresa atualizada!' : 'Empresa criada!'); closeModal('modalEmpresa'); await loadData(); render('empresas');
            } catch (e) { showToast('Erro ao salvar', 'error'); }
        }
        async function deleteEmpresa(id) { if (!confirm('Excluir empresa e todos os dados vinculados?')) return; try { await supabaseClient.from('empresas').delete().eq('id', id); showToast('Exclu√≠do!'); await loadData(); render('empresas'); } catch (e) { showToast('Erro', 'error'); } }

        // CRUD Fazendas
        function openFazendaModal(f = null) {
            document.getElementById('modalFazendaTitle').textContent = f ? 'Editar Fazenda' : 'Nova Fazenda';
            document.getElementById('fazendaEmpresa').innerHTML = '<option value="">Selecione...</option>' + empresas.map(e => `<option value="${e.id}">${e.nome}</option>`).join('');
            document.getElementById('fazendaId').value = f?.id || '';
            document.getElementById('fazendaEmpresa').value = f?.empresa_id || '';
            document.getElementById('fazendaNome').value = f?.nome || '';
            document.getElementById('fazendaResponsavel').value = f?.responsavel || '';
            document.getElementById('fazendaTelefone').value = f?.telefone || '';
            document.getElementById('fazendaArea').value = f?.area_hectares || '';
            document.getElementById('fazendaEndereco').value = f?.endereco || '';
            openModal('modalFazenda');
        }
        function editFazenda(id) { openFazendaModal(fazendas.find(f => f.id === id)); }
        async function saveFazenda() {
            const id = document.getElementById('fazendaId').value;
            const data = { empresa_id: document.getElementById('fazendaEmpresa').value, nome: document.getElementById('fazendaNome').value, responsavel: document.getElementById('fazendaResponsavel').value || null, telefone: document.getElementById('fazendaTelefone').value || null, area_hectares: document.getElementById('fazendaArea').value || null, endereco: document.getElementById('fazendaEndereco').value || null };
            try {
                if (id) await supabaseClient.from('fazendas').update(data).eq('id', id);
                else await supabaseClient.from('fazendas').insert(data);
                showToast(id ? 'Fazenda atualizada!' : 'Fazenda criada!'); closeModal('modalFazenda'); await loadData(); render('fazendas');
            } catch (e) { showToast('Erro ao salvar', 'error'); }
        }
        async function deleteFazenda(id) { if (!confirm('Excluir fazenda e dispositivos?')) return; try { await supabaseClient.from('fazendas').delete().eq('id', id); showToast('Exclu√≠do!'); await loadData(); render('fazendas'); } catch (e) { showToast('Erro', 'error'); } }

        // CRUD Dispositivos
        function openDispositivoModal(d = null) {
            document.getElementById('modalDispositivoTitle').textContent = d ? 'Editar Dispositivo' : 'Novo Dispositivo';
            document.getElementById('dispositivoFazenda').innerHTML = '<option value="">Selecione...</option>' + fazendas.map(f => `<option value="${f.id}">${f.nome} (${f.empresas?.nome||''})</option>`).join('');
            document.getElementById('dispositivoId').value = d?.id || '';
            document.getElementById('dispositivoFazenda').value = d?.fazenda_id || '';
            document.getElementById('dispositivoNome').value = d?.nome || '';
            document.getElementById('dispositivoModelo').value = d?.modelo || '';
            document.getElementById('dispositivoToken').value = d?.token_api || '';
            document.getElementById('dispositivoLat').value = d?.latitude || '';
            document.getElementById('dispositivoLng').value = d?.longitude || '';
            document.getElementById('dispositivoVazao').value = d?.vazao_nominal || '';
            document.getElementById('dispositivoUnidade').value = d?.unidade || 'm3h';
            document.getElementById('dispositivoDesc').value = d?.descricao || '';
            openModal('modalDispositivo');
        }
        function editDispositivo(id) { openDispositivoModal(dispositivos.find(d => d.id === id)); }
        async function saveDispositivo() {
            const id = document.getElementById('dispositivoId').value;
            const data = { fazenda_id: document.getElementById('dispositivoFazenda').value, nome: document.getElementById('dispositivoNome').value, modelo: document.getElementById('dispositivoModelo').value || null, token_api: document.getElementById('dispositivoToken').value, latitude: document.getElementById('dispositivoLat').value || null, longitude: document.getElementById('dispositivoLng').value || null, vazao_nominal: document.getElementById('dispositivoVazao').value || null, unidade: document.getElementById('dispositivoUnidade').value, descricao: document.getElementById('dispositivoDesc').value || null };
            try {
                if (id) await supabaseClient.from('dispositivos').update(data).eq('id', id);
                else await supabaseClient.from('dispositivos').insert(data);
                showToast(id ? 'Dispositivo atualizado!' : 'Dispositivo criado!'); closeModal('modalDispositivo'); await loadData(); render('dispositivos');
            } catch (e) { console.error(e); showToast('Erro ao salvar', 'error'); }
        }
        async function deleteDispositivo(id) { if (!confirm('Excluir dispositivo e leituras?')) return; try { await supabaseClient.from('dispositivos').delete().eq('id', id); showToast('Exclu√≠do!'); await loadData(); render('dispositivos'); } catch (e) { showToast('Erro', 'error'); } }

        // CRUD Usu√°rios
        function openUsuarioModal(u = null) {
            document.getElementById('modalUsuarioTitle').textContent = u ? 'Editar Usu√°rio' : 'Novo Usu√°rio';
            document.getElementById('usuarioEmpresa').innerHTML = '<option value="">Selecione...</option>' + empresas.map(e => `<option value="${e.id}">${e.nome}</option>`).join('');
            document.getElementById('usuarioRole').innerHTML = '<option value="">Selecione...</option>' + roles.map(r => `<option value="${r.id}">${r.nome}</option>`).join('');
            document.getElementById('usuarioFazenda').innerHTML = '<option value="">Todas as fazendas</option>' + fazendas.map(f => `<option value="${f.id}">${f.nome}</option>`).join('');
            document.getElementById('senhaGroup').style.display = u ? 'none' : 'block';
            document.getElementById('usuarioId').value = u?.id || '';
            document.getElementById('usuarioNome').value = u?.nome || '';
            document.getElementById('usuarioEmail').value = u?.email || '';
            document.getElementById('usuarioCargo').value = u?.cargo || '';
            document.getElementById('usuarioEmpresa').value = u?.empresa_id || '';
            document.getElementById('usuarioRole').value = u?.role_id || '';
            document.getElementById('usuarioFazenda').value = u?.fazenda_id || '';
            document.getElementById('usuarioSenha').value = '';
            openModal('modalUsuario');
        }
        function editUsuario(id) { openUsuarioModal(usuarios.find(u => u.id === id)); }
        async function saveUsuario() {
            const id = document.getElementById('usuarioId').value;
            const data = { nome: document.getElementById('usuarioNome').value, cargo: document.getElementById('usuarioCargo').value || null, empresa_id: document.getElementById('usuarioEmpresa').value || null, role_id: document.getElementById('usuarioRole').value || null, fazenda_id: document.getElementById('usuarioFazenda').value || null };
            try {
                if (id) {
                    await supabaseClient.from('perfis').update(data).eq('id', id);
                    showToast('Usu√°rio atualizado!');
                } else {
                    const email = document.getElementById('usuarioEmail').value;
                    const senha = document.getElementById('usuarioSenha').value;
                    const { data: authData, error } = await supabaseClient.auth.signUp({ email, password: senha, options: { data: { nome: data.nome } } });
                    if (error) throw error;
                    await supabaseClient.from('perfis').update(data).eq('id', authData.user.id);
                    showToast('Usu√°rio criado! Email de confirma√ß√£o enviado.');
                }
                closeModal('modalUsuario'); await loadData(); render('usuarios');
            } catch (e) { console.error(e); showToast(e.message || 'Erro ao salvar', 'error'); }
        }
        async function deleteUsuario(id) { if (!confirm('Excluir usu√°rio?')) return; try { await supabaseClient.from('perfis').delete().eq('id', id); showToast('Exclu√≠do!'); await loadData(); render('usuarios'); } catch (e) { showToast('Erro', 'error'); } }
    </script>
</body>
</html>
